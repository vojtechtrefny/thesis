% ============================================================================ %
% Encoding: UTF-8 (žluťoučký kůň úpěl ďábelšké ódy)
% ============================================================================ %

% ============================================================================ %
\nn{Úvod}
První odstavec pod nadpisem se neodsazuje, ostatní ano (pouze první řádek, odsazení vertikální mezy odstavci je typycké pro anglickou sazbu; czech babel toto respektuje, netřeba do textu přidávat jakékoliv explicitní formátování, viz ukázka sazby tohoto textu s následujícím odstavcem).

Formátování druhého odstavce. Text text text text text text text text text text text text.


% ============================================================================ %
\cast{Teoretická část}

\n{1}{BitLocker}
text

\n{2}{Diskový formát}

Pro samotnou práci s BitLocker zařízením v linuxovém prostředí je nejdůležitější formát, tedy způsob, jakým jsou na disku uložena data. Protože je pomocí BitLockeru možné vytvořit šifrovaný flash disk, který lze použít na jiném počítači pouze za znalosti hesla pro jeho odemčení, je zřejmé, že někde na samotném disku jsou uložena všechna potřebná metadata pro jeho odemčení v (alespoň částečně) otevřené podobě.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
		\begin{bytefield}[bitwidth=1.7em]{24}
		  \bithead{1}{16} &
		  \bithead{3}{68760} &
		  \bithead{2}{128} &
		  \bithead{3}{21440} &
		  \bithead{2}{128} &
		  \bithead{3}{22632} &
		  \bithead{2}{128} &
		  \bithead{3}{91568}\\
		  \bitbox{1}{Hl.} &
		  \bitbox{3}{Data} &
		  \bitbox{2}{FVE 1} &
		  \bitbox{3}{Data} &
		  \bitbox{2}{FVE 2} &
		  \bitbox{3}{Data} &
		  \bitbox{2}{FVE 3} &
		  \bitbox{3}{Data} & \\
		\end{bytefield}
		\caption{Zjednodušená struktura BitLocker zařízení}
		\label{fig:bitlocker-device}
\end{figure}

Na obrázku \ref{fig:bitlocker-device} je nastíněna zjednodušená struktura uložení dat a metadat na zařízení šifrovaném pomocí BitLockeru. Na začátku zařízení se nachází 8 KiB velká hlavička (podrobněji popsána v části \ref{sec:header}) obsahující základní data pro jeho identikaci a mezi zašifrovanými daty jsou uloženy tři kopie dalších metadat, každá o velikosti 64 KiB (podrobněji popsány v části \ref{sec:fve-metadata}). Čísla nad jednotlivými \uv{částmi} odpovídají jejich velikosti v sektorech pro testovací zařízení o velikosti 100 MiB, které bylo vytvořeno ve Windows 10.

\n{3}{Hlavička}\label{sec:header}

Stejně jako u většiny diskových formátů, je i u BitLockeru na začátku disku takzvaná hlavička, která obsahuje základní informace o použitém formátu a jeho vlastnostech a také k jeho rychlé identifikaci. BitLocker hlavička zabírá celkem 512 bajtů a je u ní patrná inspirace u souborového systému NTFS. V tabulce \ref{tab:bitlocker-header} jsou zobrazeny jednotlivé (známé\footnote{Struktura formátu BitLocker není společností Microsoft nikde veřejně zcela kompletně zdokumentována, význam jednotlivých položek tedy nemusí být vždy přesně znám.}) položky hlavičky BitLockeru a pro srovnání také stejné položky v hlavičce souborového systému NTFS.

Struktura NTFS hlavičky je převzata z \cite{Carrier2005}, struktura BitLocker hlavičky je pak částečně převzata z \cite{Metz2011}, částečně z \cite{Ferguson2006} a částečně výsledkem vlastního zkoumání.

\begin{table}[h]
\catcode`\-=12
\captionsetup{width=0.65\linewidth}
\caption{Porování položek hlaviček BitLocker a NTFS}
\label{tab:bitlocker-header}
\begin{center}
\centering
\begin{tabular}{|c|c|c|c|c|}
  \hline
   offset & velikost & BitLocker & NTFS \\ \hline
   0 & 3 & \multicolumn{2}{c|}{boot kód} \\ \hline
   3 & 8 & \multicolumn{2}{c|}{OEM název (signatura)} \\ \hline
   11 & 2 & \multicolumn{2}{c|}{počet bajtů na sektor} \\ \hline
   13 & 1 & \multicolumn{2}{c|}{počet sektorů na cluster} \\ \hline
   14 & 2 & \multicolumn{2}{c|}{rezervované sektory} \\ \hline
   16 & 4 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   21 & 1 & \multicolumn{2}{c|}{popisek média} \\ \hline
   22 & 18 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   40 & 8 & \multicolumn{2}{c|}{počet sektorů} \\ \hline
   48 & 8 & \multicolumn{2}{c|}{adresa prvního clusteru MFT} \\ \hline
   56 & 8 & \multicolumn{2}{c|}{kopie adresy prvního clusteru MFT} \\ \hline
   64 & 1 & \multicolumn{2}{c|}{velikost MFT entry} \\ \hline
   65 & 3 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   68 & 1 & \multicolumn{2}{c|}{velikost indexu} \\ \hline
   69 & 3 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   72 & 8 & \multicolumn{2}{c|}{NTFS serial number} \\ \hline
   80 & 4 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   84 & 76 & \multicolumn{2}{c|}{boot kód} \\ \hline
   160 & 16 & BitLocker GUID & \multirow{4}{*}{boot kód} \\ \cline{1-3}
   176 & 8 & offset první kopie FVE metadat & \\ \cline{1-3}
   184 & 8 & offset druhé kopie FVE metadat & \\ \cline{1-3}
   192 & 8 & offset třetí kopie FVE metadat & \\ \hline
   200 & 310 & \multicolumn{2}{c|}{boot kód}  \\ \hline
   510 & 2 & \multicolumn{2}{c|}{signatura (\texttt{0xaa55})} \\ \hline
\end{tabular}
\end{center}
\end{table}

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000  eb 58 90 $\textcolor{blue}{2d 46 56 45 2d}$  46 53 2d 00 02 08 00 00 |.X.$\textcolor{blue}{-FVE-FS-}$.....|
00000010  00 00 00 00 00 f8 00 00  3f 00 ff 00 00 28 03 00 |........?....(..|
00000020  00 00 00 00 e0 1f 00 00  00 00 00 00 00 00 00 00 |................|
00000030  01 00 06 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
00000040  80 00 29 00 00 00 00 4e  4f 20 4e 41 4d 45 20 20 |..)....NO NAME  |
00000050  20 20 46 41 54 33 32 20  20 20 33 c9 8e d1 bc f4 |  FAT32   3.....|
00000060  7b 8e c1 8e d9 bd 00 7c  a0 fb 7d b4 7d 8b f0 ac |{......|..}.}...|
00000070  98 40 74 0c 48 74 0e b4  0e bb 07 00 cd 10 eb ef |.@t.Ht..........|
00000080  a0 fd 7d eb e6 cd 16 cd  19 00 00 00 00 00 00 00 |..}.............|
00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
000000a0  3b d6 67 $\textcolor{green}{49 29 2e d8 4a}$  $\textcolor{green}{83 99 f6 a3 39 e3 d0 01}$ |;.gI)..J....9...|
000000b0  $\textcolor{red}{00 50 19 02 00 00 00 00}$  $\textcolor{orange}{00 d0 c1 02 00 00 00 00}$ |.P..............|
000000c0  $\textcolor{yellow}{00 a0 73 03 00 00 00 00}$  00 00 00 00 00 00 00 00 |..s.............|
000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
*
00000100  0d 0a 52 65 6d 6f 76 65  20 64 69 73 6b 73 20 6f |..Remove disks o|
00000110  72 20 6f 74 68 65 72 20  6d 65 64 69 61 2e ff 0d |r other media...|
00000120  0a 44 69 73 6b 20 65 72  72 6f 72 ff 0d 0a 50 72 |.Disk error...Pr|
00000130  65 73 73 20 61 6e 79 20  6b 65 79 20 74 6f 20 72 |ess any key to r|
00000140  65 73 74 61 72 74 0d 0a  00 00 00 00 00 00 00 00 |estart..........|
00000150  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
*
00000190  00 00 00 00 00 00 00 00  78 78 78 78 78 78 78 78 |........xxxxxxxx|
000001a0  78 78 78 78 78 78 78 78  78 78 78 78 78 78 78 78 |xxxxxxxxxxxxxxxx|
*
000001e0  78 78 78 78 78 78 78 78  ff ff ff ff ff ff ff ff |xxxxxxxx........|
000001f0  ff ff ff ff ff ff ff ff  ff ff ff 00 1f 2c 55 aa |.............,U.|
00000200
\end{lstlisting}
		\caption{BitLocker hlavička se zvýrazněnou signaturou, GUID a trojicí offsetů FVE metadat}
		\label{fig:bitlocker-header}
\end{figure}

Z pohledu identifkace BitLocker zařízení je nejdůležitější částí hlavičky 8 bajtů na offsetu 3, které se u NTFS formátu nazývají \emph{OEM název} a které slouží pro rychlou identifikace zařízení. V linuxových systémech se podobné identifikátory obvykle nazývají \emph{signatura}. \todo{TODO: To by asi chtělo citaci.} Pro BitLocker formát je (u všech verzí) signatura v ASCII podobě \texttt{-FVE-FS-}.

Pro další práci s BitLockerem není většina položek hlavičky zajímavá. Výjimku tvoří GUID identifkátor uložený na offsetu 160 (16 bajtů dlouhý UTF-8 string) a trojice \emph{uint32} hodnot na offsetech 176, 184 a 192, které obsahují umístění (jako relativní offset od začátku zkoumaného zařízení) tří bloků FVE metadat. Všechny tyto čtyři hodnoty jsou v BitLocker hlavičce umístěny na offsetech, které jsou v NTFS součástí \emph{bootcode}.

Umístění všech výše zmíněných \uv{důležitých} částí BitLocker hlavičky je zobrazeno na obrázku \ref{fig:bitlocker-header}.


\n{3}{FVE metadata}\label{sec:fve-metadata}

Samotná výše popsaná hlavička formátu BitLocker neobsahuje o samotném BitLockeru téměř žádné informace. Slouží především pro rychlou identifikaci zařízení jako zařízení šifrovaného pomocí technologie BitLocker. Všechny informace potřebné pro práci s tímto zařízením, tedy především způsob uložení dat, jejich umístění, způsob jakým jsou šifrovány a hlavně klíč pro jejich (de)šifrování je uložený na třech různých místech\footnote{Na offsetech přibližně ve 33 \%, 44 \% a 55 \% u testovaných BitLocker zařízeních.} definovaných v hlavičce. Jedná se o tři identické kopie\footnote{Tři kopie jsou zvoleny pravděpodobně jako záloha pro případ náhodného poškození metadat. Vzhledem k tomu, že bez kompletní nepoškozené kopie těchto metadat není možné data na zařízení dešifrovat, je vícenásobná záloha na místě.} takzvaných \emph{FVE metadat}.

FVE metadata se skládají z celkem tří částí -- hlavičky FVE bloku (\emph{FVE metadata block header}), samotné FVE hlavičky (\emph{FVE metadata header}) a různého množství FVE záznamů (\emph{FVE metadata entry}, které obsahují samotné klíče a další důležité informace\cite{Metz2011}\footnote{Toto dělení zavádí Joachim Metz v \cite{Metz2011}. Teoreticky by se daly dvě první části metadat spojit, protože na disku se nachází vždy hned za sebou, ale rozdělení dává smysl, protože první část se týká popisu samotných metadat (signatura, verze, umístění všech tří bloků), zatímco druhá část už obsahuje samotná metadata (GUID, čas vytvoření, použitý šifrovací algoritmus).}.

Důležité položky v obou hlavičkách, jejich velikosti a offsety (vztažené vůči začátku dané hlavičky) jsou uvedeny v tabulce \ref{tab:fve-header}. Kompletní struktura obou hlaviček je součástí přílohy \todo{TODO: odkaz na přílohu}.

\tab{Zjednodušená struktura FVE metadat}{tab:fve-header}{0.65}{|l|l|l|}{
  \hline
   \multicolumn{3}{|c|}{\textbf{Hlavička FVE bloku}} \\ \hline
   offset & velikost & popis  \\ \hline
   0 & 8 & signatura (\texttt{-FVE-FS-}) \\ \hline
   10 & 2 & verze (1 nebo 2) \\ \hline
   32 & 8 & offset první kopie FVE metadat \\ \hline
   40 & 8 & offset druhé kopie FVE metadat \\ \hline
   48 & 8 & offset třetí kopie FVE metadat  \\ \hline
   \multicolumn{3}{}{} \\ \hline
   \multicolumn{3}{|c|}{\textbf{FVE hlavička}} \\ \hline
   0 & 4 & velikost metadat (včetně záznamů) \\ \hline
   16 & 16 & GUID \\ \hline
   36 & 4 & šifrovací algoritmus \\ \hline
   40 & 8 & datum a čas vytvoření \\ \hline
}

Mezi pro nás zajímavé položky v hlavičce patří její celková velikost (včetně velikosti samotné hlavičky a velikosti za ní následujícíh záznamů), šifrovací algoritmus použitý pro zašifrování dat uložených na disku (možné algoritmy jsou popsány v části \ref{sec:algorithms}) a v některých případech může být užitečný i čas vytvoření, který je uložen ve formátu \texttt{FILETIME}\footnote{FILETIME je ve skutečnosti struktura sestávající ze dvou 32bit integer hodnot, které dohromady udávají počet 100 nanosekundových intervalů, které k danému datu uplynuly od 1. ledna 1601.\cite{Zxwr6wjYZUQ6z8Yp}}.

\n{3}{FVE záznamy}\label{sec:fve-metadata-entry}

Za výše uvedenou hlavičkou se nechází blíže nespecifikované množství FVE záznamů. Ty slouží v podstatě jako key-value úložiště pro jakékoli další \uv{informace}, které jsou pro práci s BitLockerem potřebné. Tím, že není třeba předem určeno, kolik takových záznamů bude za hlavičkou uloženo, je možné přidávat nové položky při zachování zpětné kompatibility\footnote{Celková největší možná velikost FVE metadat je 64 KiB (alespoň tedy tolik je pro FVEm metadata vyhrazeno na vytvořených BitLocker zařízeních), teoreticky je tedy možné mít až 64 KiB - 112 B metadat.}.

Jelikož známe celkovou velikost FVE metadat (je uvedena v hlavičce, viz tabulka \ref{tab:fve-header}) a celková velikosti hlaviček FVE metadat je pevná (64 a 48 bajtů), pro přečtení všech záznamů stačí číst data ve smyččce, dokud nedojdeme na konec metadat, nebo dokud následující záznam nemá nulovou velikost.

Struktutra FVE je relativně jednoduchá a je popsaná v tabulce \ref{tab:fve-entry}. Důležitou součástí je velikost záznamu, protože podle svého typu může mít různou délku.

\tab{Struktura FVE záznamu}{tab:fve-entry}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 2 & velikost záznamu \\ \hline
   2 & 2 & typ záznamu \\ \hline
   4 & 2 & typ hodnoty záznamu \\ \hline
   6 & 2 & verze (1) \\ \hline
   8 &  & data  \\ \hline
}

Typ a hodnota označují, co je v daném záznamu uloženo. Známé typy a hodnoty jsou popsány v tabulce \ref{tab:fve-entry-types}. U typů se typicky jedná buď o klíč (FVEK, VMK) nebo obecnou property, hodnota pak dále specifikuje, jak je daný typ uložen (zašifrovaný klíč, unicode string).

Způsob uložení dat záleží na tom, jaká konkrétní data jsou v záznamu uložena. U \uv{jednoduchých} záznamů, jako je například popisek je v datech uložen textový řetězec uložený v kódování UTF-16, u \uv{složitějších} záznamů, jako jsou například klíče, mají data vlastní strukturu včetně dalších záznamů.

\begin{table}[h]
\catcode`\-=12
\captionsetup{width=0.65\linewidth}
\caption{Známé typy FVE záznamů}
\label{tab:fve-entry-types}
\begin{center}
\centering
\begin{tabular}{|l|l|c|l|l|}
  \cline{1-2} \cline{4-5}
   \multicolumn{2}{|c|}{\textbf{Typy}} &  & \multicolumn{2}{|c|}{\textbf{Hodnoty}} \\ \cline{1-2} \cline{4-5}
   typ & popis &  & typ & popis \\ \cline{1-2} \cline{4-5}
   0 & property & & 0 & smazáno \\ \cline{1-2} \cline{4-5}
   1 & VMK & & 1 & klíč \\ \cline{1-2} \cline{4-5}
   2 & FVEK & & 2 & string \\ \cline{1-2} \cline{4-5}
   7 & popisek & & 5 & AES-CCM šifrovaný klíč \\ \cline{1-2} \cline{4-5}
   15 & hlavička disku\footnotemark & & 6 & TPM klíč \\ \cline{1-2} \cline{4-5}
   \multicolumn{2}{c}{} & & 8 & VMK \\ \cline{4-5}
   \multicolumn{2}{c}{} & & 15 & offset a velikost \\ \cline{4-5}
   

\end{tabular}
\end{center}
\end{table}

\footnotetext{Umístění a velikost NTFS hlavičky otevřeného zařízení. Odpovídá hodnotě 15. Podrobnější informace o umístění NTFS hlavičky na šifrovaném zařízení jsou v části \ref{sec:data-map}.}

Příklad \uv{jednoduchého} záznamu je uveden na obrázku \ref{fig:fve-entry-desc}, kde vidíme záznam typu \emph{description}. Ten v podstatě obsahuje jméno počítače, na kterém bylo dané BitLocker zařízení vytvořeno a také datum vytvoření. Můžeme tedy vidět, že toto konkrétní BitLocker zařízení bylo vytvořeno na počítači \texttt{DESKTOP-NPM7RCA} a to 3. února 2019. Tato informace je uloženo jako standardní string v kódování UTF-16. Kromě tohoto stringu jsou pak na obrázku zvýrazněny i další údaje: velikost celého záznamu (64 bajtů), jeho typ (7 -- popisek) a hodnota (2 -- string) a verze (1).


\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
02195070  $\textcolor{red}{40 00}$ $\textcolor{orange}{07 00}$ $\textcolor{yellow}{02 00}$ $\textcolor{green}{01 00}$  $\textcolor{blue}{44 00 45 00 53 00 4b 00}$ |@.......$\textcolor{blue}{D.E.S.K.}$|
02195080  $\textcolor{blue}{54 00 4f 00 50 00 2d 00}$  $\textcolor{blue}{4e 00 50 00 4d 00 37 00}$ |$\textcolor{blue}{T.O.P.-.N.P.M.7.}$|
02195090  $\textcolor{blue}{52 00 43 00 41 00 20 00}$  $\textcolor{blue}{47 00 3a 00 20 00 32 00}$ |$\textcolor{blue}{R.C.A. .G.:. .2.}$|
021950a0  $\textcolor{blue}{2f 00 33 00 2f 00 32 00}$  $\textcolor{blue}{30 00 31 00 39 00}$ 00 00 |$\textcolor{blue}{/.3./.2.0.1.9.}$..|
\end{lstlisting}
		\caption{Příklad FVE záznamu typu \uv{description} (popisek)}
		\label{fig:fve-entry-desc}
\end{figure}

U jednoduchého zařízení --- v našem případě USB flash disku --- se bude obvykle vyskytovat pouze pět záznamů a to již výše zmíněný popisek, dvojice záznamů typu VMK, jeden záznam typu FVEK (o obou více v části \ref{sec:keys} a jeden záznam obsahující informace o umístění hlavičky disku (o tomto záznamu více v části \ref{sec:data-map}).

\n{2}{Klíče}\label{sec:keys}

Pravděpodobně nejdůležitější součástí BitLocker hlavičky jsou šifrovací klíče. Ve FVE hlavičce nalezneme celkem dva typy klíčů --- Full Volume Encryption Key, neboli FVEK, a Volume Master Key, neboli VMK\footnote{Původní varianta BitLockeru má ještě jeden klíč --- TWEAK, ten je podrobnějí popsán v části \ref{sec:old-versions}.}. Uloženy jsou v metadatových záznamech odpovídajících typů a to samozřejmě nikoli v otevřené podobě, ale zašifrované.

\n{3}{Full Volume Encryption Key}

Full Volume Encryption Key (dále jen \uv{FVEK}) je nejdůležitějším klíčem pro celý BitLocker. Pomocí tohoto klíče jsou totiž zašifrovaná data uložená na disku. FVEK samotný nejde změnit\footnote{Bez kompletního přešifrování všech dat.} a v případě jeho poškození nebo náhodného smazání není možné uložená data nijak dešifrovat.

FVEK je v metadatech uložen v záznamu typu \emph{FVEK} s hodnotou \emph{AES-CCM šifrovaný klíč} a je, jak hodnota naznačuje, zašifrován pomocí šifry AES-CCM (o této šifře a módu více v části \ref{sec:algorithms}), kdy je jako klíč použit VMK a jako inicializační vektor 0.

\tab{Způsob uložení FVEK v metadatech}{tab:fvek-data}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 8 & datum a čas vytvoření (jako FILETIME) \\ \hline
   8 & 4 & nonce \\ \hline
   12 & 16 & MAC tag \\ \hline
   28 & 44\footnotemark & šifrovaný klíč \\ \hline
}
\footnotetext{Velikost šifrovaného klíče záleží na použité šifře --- 12 bajtů vždy připadne na informace o klíči a 32 bajtů v tomto případě připadá na samotný klíč, jelikož je použit 128bit AES.}

Struktura dat pro FVEK v metadatovém záznamu je popsána v tabulce \ref{tab:fvek-data}. Kromě samotného klíče obsahují datum a čas jeho vytvoření a nonce\todo{TODO: najít definici a citaci}.

Samotná zašifrovaná část klíče obsahuje kromě samotného klíče také další data o klíči samotném --- velikost, verze a šifrovací metoda použitá pro data zašifrovaná pomocí FVEK. Jejich struktura je popsána v tabulce \ref{tab:fvek-data-decrypted}.

\tab{Obsah FVEK po dešifrování}{tab:fvek-data-decrypted}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 4 & velikost \\ \hline
   4 & 4 & verze (1)\footnotemark \\ \hline
   8 & 4 & šifrovací metoda \\ \hline
   12 & 32 & klíč \\ \hline
}

Na obrázku \ref{fig:fvek-decrypted} je pak vidět příklad dešifrovaného FVEK. Zvýrazněny jsou jeho celková velikost (44 bajtů), verze (1), šifrovací metoda (hex kód \texttt{0x8004} v tomto případě znamená 128bit AES-XTS) a následně samotný 128bit klíč.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000  $\textcolor{red}{2c 00 00 00}$ $\textcolor{green}{01 00 00 00}$  $\textcolor{orange}{04 80 00 00}$ $\textcolor{blue}{a4 d0 11 64}$ |,..............d|
00000010  $\textcolor{blue}{0c a0 df ec b2 4d a2 39}$  $\textcolor{blue}{b1 4e 4a b7 62 56 f2 e3}$ |.....M.9.NJ.bV..|
00000020  $\textcolor{blue}{b2 27 54 40 91 21 0e 98}$  $\textcolor{blue}{aa 84 5f 52}$             |.'T@.!...._R|
\end{lstlisting}
		\caption{Dešifrovaný FVEK}
		\label{fig:fvek-decrypted}
\end{figure}

\footnotetext{Některé zdroje \cite{Metz2011} uvádějí verzi pouze jako 2 bajtovou a následující 2 bajty jako \uv{neznámé}. Vzhledem k tomu, že v jiných hlavičkách je verze v některých případech 4 bajtová a v některých 2 bajtová a že na testovacích zařízeních byly tyto dva bajty vždy nulové, domnívám se, že je pravděpodobnější, že verze je zde 4 bajtová.}

\n{3}{Volume Master Key}

Jak již bylo řečeno výše, FVEK je na disku uložen zašifrován pomocí Volume Master Key (dále jen \uv{VMK}). Ten je uložen také v metadatových záznamech v hlavičce a je také zašifrován. Narozdíl od FVEK, který je vždy uložen v metadatech v jediné kopii, VMK může být v metadatech uložen vícekrát, pokaždé \uv{jinak} zašifrovaný.

Tento systém umožňuje, aby byl FVEK, jakožto hlavní a nejdůležitější klíč, uložen na disku pouze v jedné kopii, ale zároveň existovala možnost, jak mít pro jedno zařízení více různých hesel (respektive více různých způsobů odemčení daného zařízení). Pro přidání \uv{nového} hesla tak teoreticky stačí jednoduše znát alespoň jedno již existující, pomocí kterého se VMK dešifruje a následně uloží zašifrovaný pomocí nového hesla. Analogicky tak lze také snadno změnit heslo --- jak již bylo zmíněno výše, FVEK nejde změnit bez přešifrování celého zařízení, ale změna hesla díky tomuto systému znamená pouhé uložení nově zašifrovaného VMK.

V odstavci výše je několikrát zmíněno \emph{heslo}, ale VMK může být chráněn více různými způsoby. Dokumentace BitLockeru \cite{Zxwr6wjYZUQ6z8Yo} zmiňuje celkem deset možných typů \emph{protektorů} klíčů v BitLockeru, které jsou zapsány v tabulce \ref{tab:vmk-protectors}.

\tab{Možnosti ochrany VMK}{tab:vmk-protectors}{0.65}{|l|l|}{
  \hline
   hodnota & popis  \\ \hline
   0 & neznámý/jiný \\ \hline
   1 & TPM \\ \hline
   2 & externí klíč \\ \hline
   3 & číselné heslo \\ \hline
   4 & TPM a PIN \\ \hline
   5 & TPM klíč \\ \hline
   6 & TPM, PIN a klíč \\ \hline
   7 & veřejný klíč \\ \hline
   8 & heslo \\ \hline
   9 & TPM certifikát \\ \hline
  10 & CryptoAPI Next Generation (CNG) \\ \hline
}

Z pohledu této práce je nejobvyklejším protektorem právě heslo, protože použití BitLocker zařízení v linuxovém prostředí se dá předpokládat primírně u flash disků, u nichž se používá ochrana heslem\footnote{Ochrana pomocí TPM nedává u přenosných disků smysl, protože TPM čipy jsou nedělitelnou součástí hardwaru.}.

Pro každé vytvořené BitLocker se kromě \uv{primární} ochrany (v našem případě typicky hesla) vytváří ještě jeden VMK chráněný záložním heslem. Způsob ochrany je u něj stejný jako u VMK, který je chráněný heslem, rozdíl je v tom, že heslo zadává uživatel, kdežto záložní heslo je vygenerované a uživateli je při vytváření \uv{předáno} v podobě souboru, který obsahuje 48 čísel. \todo{TODO: citace}

Struktura VMK, naznačená v tabulce \ref{tab:vmk-data}, je ovlivněna tím, že samotný klíč může být chráněn různými způsoby a je pro něj tedy třeba ukládat různá metadata a i samotný klíč může být třeba v některých případech ukládat v různých podobách.

První část VMK struktury je v celku běžná --- obsahuje identifikátor klíče (GUID), čas vytvoření a typ ochrany. Další metadata jsou pak uložena jako záznamy, stejně jako u samotné FVE hlavičky (podrobněji v části \ref{sec:fve-metadata-entry} a tabulce \ref{tab:fve-entry}).

\tab{Struktura VMK}{tab:vmk-data}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 16 & GUID \\ \hline
   16 & 9 & datum a čas vytvoření \\ \hline
   24 & 2 & neznámé \\ \hline
   26 & 2 & typ ochrany \\ \hline
   28 &  & metadatové záznamy \\ \hline
}

Kompletní VMK klíč chráněný záložním heslem je zobrazen na obrázku \ref{fig:vmk-bpwprotected}. Zvýrazněno je GUID, typ ochrany (8 --- heslo) a dva \uv{připojené} záznamy, oba typu property, první obsahující sůl potřebnou pro odvození klíče potřebného pro dešifrování VMK ze záložního hesla (funkcionalita odvození klíče z hesla je popsána v části \todo{TODO: odkaz na část popisující KDF}) a druhá obsahující samotný klíč (textový výpis je debugovacím výstupem z nástroje vytvořeného v rámci praktické části).

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000 $\textcolor{blue}{c1 56 2e 01 d6 4e 27 45}$  $\textcolor{blue}{8a bf 7a 9f 29 e0 b5 21}$  |.V...N'E..z.)..!|
00000010 40 c5 cd 54 a0 bb d4 01  00 00 $\textcolor{red}{00 08}$ ac 00 00 00  |@..T............|
00000020 03 00 01 00 00 10 00 00  $\textcolor{green}{46 ee b7 10 0e 43 4d d4}$  |........F....CM.|
00000030 $\textcolor{green}{f1 84}$ a5 ab eb c6 21 f4  40 00 12 00 05 00 01 00  |....!...@.......|
00000040 40 7d e5 52 a0 bb d4 01  04 00 00 00 72 b0 71 f4  |@}.R........r.q.|
00000050 20 9e c9 8e b7 1b 5e 42  71 b5 bc 21 c6 57 9b 29  | .....^Bq..!.W.)|
00000060 56 2c 92 ad db d7 73 75  a9 78 c2 94 c5 a5 07 d1  |V,....su.x......|
00000070 62 61 0c 56 d8 ca 9d ac  50 00 13 00 05 00 01 00  |ba.V....P.......|
00000080 40 7d e5 52 a0 bb d4 01  05 00 00 00 3e d9 ac 58  |@}.R........>..X|
00000090 e6 86 ba ac 05 48 ea 0b  64 ee 77 7a b4 77 ba cb  |.....H..d.wz.w..|
000000a0 c0 83 83 b0 7b ab 52 c7  0d 9e 8f 62 d7 cb a3 90  |....{.R....b....|
000000b0 cc b8 8e 39 a4 be 8a 0a  5c 16 86 62 c9 64 81 4d  |...9....\..b.d.M|
000000c0 91 9d 27 24 3a 8e a3 7c  50 00 00 00 05 00 01 00  |..'.:..|P.......|
000000d0 40 7d e5 52 a0 bb d4 01  06 00 00 00 97 18 2f d6  |@}.R........../.|
000000e0 83 de e7 63 0a fa 57 48  44 2b 66 90 $\textcolor{orange}{91 a0 ad e9}$  |...c..WHD+f.....|
000000f0 $\textcolor{orange}{0c 08 e8 1e 3d 2f 7d 3b}$  $\textcolor{orange}{cc 9f ba e4 ed b5 6b c2}$  |....=/};......k.|
00000100 $\textcolor{orange}{e1 a4 53 cf c5 60 2a 92}$  $\textcolor{orange}{2d c8 1d 85 10 b7 99 87}$  |..S..`*.-.......|
00000110 $\textcolor{orange}{9d 1d 1e 36 46 40 6b e7}$                           |...6F@k.        |

VMK
	Identifier:	$\textcolor{blue}{012e56c1-4ed6-4527-8abf-7a9f29e0b521}$
	Type:		$\textcolor{red}{VMK protected with recovery password}$
	Salt:		$\textcolor{green}{46 ee b7 10 0e 43 4d d4 a5 ab eb c6 21 f4 f1 84}$
	AES-CCM encrypted key
		Nonce data:	2019-02-03 09:10:36.052000
		Nonce counter:	6
		Key:	 $\textcolor{orange}{91 a0 ad e9 0c 08 ... 1d 1e 36 46 40 6b e7}$
\end{lstlisting}
		\caption{VMK chráněný záložním heslem}
		\label{fig:vmk-bpwprotected}
\end{figure}


\n{2}{Šifrovaná data}

\n{3}{Způsob uložení data}\label{sec:data-map}

Po hlavičkách a metadatech zbývá popsat jen způsob, jakým jsou na disku uložena samotná šifrovaná data. Protože BitLocker metadata se vyskytují celkem ve třech kopiích na různých místech \uv{uprostřed} šifrovaného zařízení, jsou uložená data rozdělena celkem na čtyři části. Až na jednu výjimku jsou šifrovaná data uložena na \uv{správných} místech --- tedy na místě, kde mají být uloženy i po dešifrování.

Výjimkou je v tomto případě hlavička souborového systému NTFS a její \uv{nesprávné} umístění je způsobeno poněkud zvláštním rozhodnutím tvůrců BitLockeru, že otevřené zařízení bude mít stejnou velikost, jako zařízení zašifrované a to i přesto, že si z jeho celkové velikosti BitLocker metadata uberou přibližně 200 KiB\footnote{U linuxové implementace šifrování disku, technologie LUKS/dm-crypt, byl zvolen jiný přístup --- otevřené zařízení je menší a metadata se na něm nijak neřeší --- jsou z výsledného zařízení \uv{odstraněna}. První sektor otevřeného zařízení pak obsahuje standardní hlavičku souborového systému bez potřeby dalšího \uv{přesouvání} jako u BitLockeru.}.

\obr{Schéma \uv{mapování} mezi šifrovaným a otevřeným BitLocker zařízením}{fig:bitlocker-decrypt}{0.75}{img/bitlocker-decrypt-schema.png}

Speciální zacházení vyžaduje NTFS hlavička proto, že na výsledném otevřeném zařízení musí být na jeho začátku, aby toto zařízení bylo systémem správně rozpoznáno jako NTFS a jako takové připojeno. Proto je třeba NTFS hlavičku přesunout na začátek disku a nahradit jí původní BitLocker hlavičku. Umístění NTFS hlavičky v šifrovaných datech je zapsáno ve FVE metadatech ve speciálním záznamu typu \emph{hlavička disku} (viz tabulka \ref{tab:fve-entry-types}). V záznamu je uveden offset (relativně k začátku disku), na kterém se zašifrovaná NTFS hlavička nachází a její velikost (u testovaných zařízení 8 KiB).

Vzhledem k tomu, že výsledné otevřené zařízení má mít stejnou velikosti, jak šifrované zařízení, zbývá vyřešit, jak budou v otevřeném zařízení vyřešena metadata --- na jejich místě v otevřeném NTFS musí \uv{něco} být a zároveň je třeba je ochránit proti náhodnému přepsání nebo smazání. Teoreticky je možné tato metadata prostě dešifrovat stejně jako ostatní šifrovaná data. Výsledkem pak by pak sice byla nesmyslná data, ale pokud je zařízení již otevřeno, není třeba k metadatům již dále přistupovat. Takováto \uv{nesmyslná} data by už jen stačilo v rámci NTFS ochránit před přepsáním. Pokud by bylo třeba k metadatům přistupovat i u otevřeného zařízení by bylo další možností nechat je prostě viditelná tak, jak jsou (a opět je ochránit před přepsání).

Autoři BitLockeru ale nakonec sáhli po třetí možnosti --- metadata jsou v otevřeném zařízení nahrazena nulami. Ve výsledném otevřeném NTFS tak jsou metadata viditelná jako speciální systémové soubory uložené ve složce \texttt{System Volume Information}. Soubory jsou samozřejmě prázdné, respektive plné nul, ale zabraňují přepsání míst, na kterých se skutečná metadata vyskytují.

\n{3}{Postup při dešifrování}

Při znalosti struktury metadat a způsobu uložení šifrovaných dat, je dešifrování již celkem jednoduchou záležitostí --- z FVE hlavičky (tabulka \ref{tab:fve-header}) zjistíme, jaký byl použit šifrovací algoritmus (v nejnovějších verzích BitLockeru to bude AES-XTS), pomocí uživatelem zadaného hesla dešifrujeme VMK s odpovídajícícm typem ochrany (tabulka \ref{tab:vmk-protectors}) a pomocí něj dešifrujeme FVEK, kterým jsou zašifrována samotná data.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000  eb 52 90 4e 54 46 53 20  20 20 20 00 02 08 00 00  |.R.NTFS    .....|
00000010  00 00 00 00 00 f8 00 00  3f 00 ff 00 00 28 03 00  |........?....(..|
00000020  00 00 00 00 80 00 00 00  ff 1f 03 00 00 00 00 00  |................|
00000030  55 21 00 00 00 00 00 00  02 00 00 00 00 00 00 00  |U!..............|
00000040  f6 00 00 00 01 00 00 00  52 53 3d 84 7d 3d 84 a4  |........RS=.}=..|
00000050  00 00 00 00 fa 33 c0 8e  d0 bc 00 7c fb 68 c0 07  |.....3.....|.h..|
00000060  1f 1e 68 66 00 cb 88 16  0e 00 66 81 3e 03 00 4e  |..hf......f.>..N|
00000070  54 46 53 75 15 b4 41 bb  aa 55 cd 13 72 0c 81 fb  |TFSu..A..U..r...|
00000080  55 aa 75 06 f7 c1 01 00  75 03 e9 dd 00 1e 83 ec  |U.u.....u.......|
00000090  18 68 1a 00 b4 48 8a 16  0e 00 8b f4 16 1f cd 13  |.h...H..........|
000000a0  9f 83 c4 18 9e 58 1f 72  e1 3b 06 0b 00 75 db a3  |.....X.r.;...u..|
000000b0  0f 00 c1 2e 0f 00 04 1e  5a 33 db b9 00 20 2b c8  |........Z3... +.|
000000c0  66 ff 06 11 00 03 16 0f  00 8e c2 ff 06 16 00 e8  |f...............|
000000d0  4b 00 2b c8 77 ef b8 00  bb cd 1a 66 23 c0 75 2d  |K.+.w......f#.u-|
000000e0  66 81 fb 54 43 50 41 75  24 81 f9 02 01 72 1e 16  |f..TCPAu$....r..|
000000f0  68 07 bb 16 68 52 11 16  68 09 00 66 53 66 53 66  |h...hR..h..fSfSf|
00000100  55 16 16 16 68 b8 01 66  61 0e 07 cd 1a 33 c0 bf  |U...h..fa....3..|
00000110  0a 13 b9 f6 0c fc f3 aa  e9 fe 01 90 90 66 60 1e  |.............f`.|
00000120  06 66 a1 11 00 66 03 06  1c 00 1e 66 68 00 00 00  |.f...f.....fh...|
00000130  00 66 50 06 53 68 01 00  68 10 00 b4 42 8a 16 0e  |.fP.Sh..h...B...|
00000140  00 16 1f 8b f4 cd 13 66  59 5b 5a 66 59 66 59 1f  |.......fY[ZfYfY.|
00000150  0f 82 16 00 66 ff 06 11  00 03 16 0f 00 8e c2 ff  |....f...........|
00000160  0e 16 00 75 bc 07 1f 66  61 c3 a1 f6 01 e8 09 00  |...u...fa.......|
00000170  a1 fa 01 e8 03 00 f4 eb  fd 8b f0 ac 3c 00 74 09  |............<.t.|
00000180  b4 0e bb 07 00 cd 10 eb  f2 c3 0d 0a 41 20 64 69  |............A di|
00000190  73 6b 20 72 65 61 64 20  65 72 72 6f 72 20 6f 63  |sk read error oc|
000001a0  63 75 72 72 65 64 00 0d  0a 42 4f 4f 54 4d 47 52  |curred...BOOTMGR|
000001b0  20 69 73 20 63 6f 6d 70  72 65 73 73 65 64 00 0d  | is compressed..|
000001c0  0a 50 72 65 73 73 20 43  74 72 6c 2b 41 6c 74 2b  |.Press Ctrl+Alt+|
000001d0  44 65 6c 20 74 6f 20 72  65 73 74 61 72 74 0d 0a  |Del to restart..|
000001e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001f0  00 00 00 00 00 00 8a 01  a7 01 bf 01 00 00 55 aa  |..............U.|
00000200
\end{lstlisting}
		\caption{První sektor dešifrovaného BitLocker zařízení (NTFS hlavička)}
		\label{fig:ntfs-header}
\end{figure}

Jedinou neznámou potřebnou pro dešifrování dat tak zůstává inicializační vektor. Ten je naštěstí u nejnovější verze BitLockeru velice jednoduchý a odpovídá offsetu (v sektorech), na kterém jsou daná šifrovaná data uložena na zašifrovaném zařízení (první sektor NTFS hlavičky, který bude v dešifrovaných datech uložen na začátku tak má inicializační vektor daný svou pozicí v šifrovaných datech, nikoli nulový, jak by se mohlo zdát).

Dešifrovaný první sektor je vidět na obrázku \ref{fig:ntfs-header}. Jde zde velmi dobře poznat podobnost NTFS hlavičky s BitLocker hlavičkou (obrázek \ref{fig:bitlocker-header}). Hlavní odlišností je signatura, která je zde jasně viditelná jako \texttt{NTFS}, narozdíl od \texttt{-FVE-FS-} u BitLockeru. Chybí také offsety BitLocker metadat, které u BitLocker hlavičky \uv{zabírají} část boot kódu, který je u NTFS kompletní. Zajímavá je stejná boot signatura (\texttt{55 aa}) u obou hlaviček.

U zbývajících dat pak dešifrování probíhá stejně --- po 512 B sektorech s inicializačním vektorem nastaveným na číslo sektoru odpovídající jejich umístění na šifrovaném zařízení. Jedinou výjimkou jsou oblasti BitLocker metadata, která jsou nahrazena nulami, jak bylo popsáno v části \ref{sec:data-map}.

\n{2}{Odlišnosti ve starších verzích}\label{sec:old-versions}

Výše popsaná struktura diskového formátu BitLocker, způsob uložení klíčů a rozložení dat na šifrovaném a dešifrovaném zařízení, odpovídají aktuální nejnovější verzi BitLockeru dostupné ve Windows 7 a novějších. Původní verze dostupná ve Windows Vista se v některých drobnostech mírně liší. Tato práce se primárně zaobírá nejnovější verzí, protože je v současné době jedinou podporovanou (oficiální podpora Windows Vista byla ukončena 11. dubna 2017\cite{hfTs55csrXKY7b4F}). Podpora pro starší verze však může být také v některých případech vyžadovaná, a proto si ve stručnosti představíme nejvýznamnější odlišnosti mezi těmito verzemi.

Nejvýraznější změnou je nejspíše změna algoritmu použitého pro šifrování data z AES-CBC na AES-XTS (rozdíl mezi těmito algoritmy a pravděpodobný důvod pro změnu je popsán v části \ref{sec:algorithms}), ale menší změny se týkají i samotných metadat a hlavičky.

\n{3}{Hlavička}

Samotná BitLocker hlavička se změnila jen minimálně. Zajímavé je, že starší verze obsahuje \uv{odkaz} pouze na první kopii FVE metadat a to přesto, že i tato verze obsahuje tři kopie. Offsety ostatních kopií je tak třeba vyčíst ze samotných metadat. Díky tomu se všechna metadata specifická pro BitLocker \uv{vešla} do nevyužitých oblastí v NTFS hlavičce (od které je BitLocker hlavička odvozen, viz \ref{sec:header}) a nezasahují tak do boot kódu. Na druhou stranu v případě poškození první kopie FVE metadat bude složitější najít na disku další dvě \uv{záložní} kopie.

\n{3}{FVE metadata}

FVE metadata se u starší verze liší pouze v drobných detailech. Výhodou FVE metadat je, že jsou verzovaná a lze tak snadno rozpoznat, u jakou variantu BitLockeru se jedná. Starší varianta má verzi 1, novější varianta má verzi 2. Důležité hodnoty (signatura, velikost, umístěné offsetů všech tří kopií FVE metadat) jsou v obou verzích stejné.

\n{3}{Klíče}

Struktura klíčů VMK a FVEK se u starší verze BitLockeru nijak neliší. Jediný rozdíl představuje \uv{nový} klíč TWEAK, který se používá pro šifrování inicializačního vektoru. TWEAK klíč je uložen, podobně jako FVEK, zašifrovaný pomocí VMK ve FVE metadatech jako speciální záznam (viz \ref{sec:fve-metadata-entry}).

\n{3}{Šifrovaná data}

Asi největší odlišnost u starších verzí je ve způsobu uložení šifrovaných dat a to především v umístění NTFS hlavičky otevřeného zařízení. Zatímco u novější verze BitLockeru je tato hlavička zašifrovaná a uložená na speciálním místě zapsaném ve FVE metadatech (způsob umístění šifrované NTFS hlavičky je popsán v části \ref{sec:data-map}), v původní variantě BitLockeru je NTFS hlavička uložena nezašifrovaná a to přímo na svém \uv{původním} místě na začátku disku. Vzhledem k malé odlišnosti původní hlavičky BitLockeru a hlavičky NTFS stačí při dešifrování nahradit určité části BitLocker hlavičky a výsledkem je validní NTFS hlavička pro dešifrované zařízení. 

Nahradit je třeba signaturu --- místo původního \texttt{-FVE-FS-} dosadíme \texttt{NTFS} (standardní signatura souborového systému NTFS) a offset první kopie FVE metadat --- ten nahradí adresa prvního clusteru MFT, která je uložen ve FVE metadatech.

Poslední rozdíl v šifrovaných datech spočívá v inicializačním vektoru použitém pro jejich (de)šifrování. Stejně jako u novější verze BitLockeru se zde použije číslo sektoru, ale nikoli \uv{prosté}, ale zašifrované pomocí TWEAK klíče.

\n{1}{Existující řešení pro práci s BitLockerem v Linuxu}

Pro Linux již v současné době existují nástroje, které umí s BitLockerem více či méně pracovat. Podle aktivity vývoje a pokrytí funkcionality BitLockeru jsou nejvýznamnější dva projekty --- knihovna libbde\cite{Metz2018} a nástroj Dislocker

\n{2}{libbde}

Knihovna libbde vytvořená Joachimem Metzem představuje asi nejlepší software pro práci s BitLockerem v linuxových systémech a nejen tam, protože podporuje i systémy Microsoft Windows a MacOS X\cite{Metz2016}. Kromě knihovny jsou součástí projektu i nástroje pro koncové uživatele \texttt{bdemount} a \texttt{bdeinfo}. Ukázka výstupu nástroje \texttt{bdeinfo}, který slouží primárně pro analýzu existujících zařízení, je vidět na obrázku \ref{fig:libbde-bdeinfo}. Užitečná může být také dostupnost rozhraní pro jazyk Python (samotná knihovna je implementována v jazyce C).


\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
BitLocker Drive Encryption information:
	Encryption method		: AES-XTS 128-bit
	Volume identifier		: 1f8bf933-8323-4c97-8a89-a67625ac8f40
	Creation time			: Feb 03, 2019 09:10:22.265405900 UTC
	Description			: DESKTOP-NPM7RCA G: 2/3/2019
	Number of key protectors	: 2

Key protector 0:
	Identifier			: f0f61678-fb6f-4ab1-934a-7094f5b68a85
	Type				: Password

Key protector 1:
	Identifier			: 012e56c1-4ed6-4527-8abf-7a9f29e0b521
	Type				: Recovery password
\end{lstlisting}
		\caption{Ukázka výstupu nástroje \texttt{bdeinfo}}
		\label{fig:libbde-bdeinfo}
\end{figure}

Podpora BitLockeru, kterou libbde poskytuje, je velice rozsáhlá a dokáže pracovat se všemi existujícími formáty a verzemi. Dokumentace pro tuto knihovnu také obsahuje obsáhlý popis BitLockeru, formátu hlaviček a metadat\cite{Metz2011}, který byl neocenitelný při přípravě této diplomové práce.

Bohužel i přes tyto dobré zprávy má knihovna libbde několik vlastností, které z ní dělají nevhodného kandidáta na nástroj pro každodenní použití. Předně je zde problém s neexistující podporou pro zápis --- otevřené zařízení je připojitelné pouze pro čtení a ačkoli je podpora pro zápis plánována již od roku 2014\footnote{https://github.com/libyal/libbde/issues/1}\todo{TODO: citaci nebo stačí takhle?}, stále není k dispozici. Kvůli tomu se může jednat o nástroj vhodný pro forenzní analýzu nebo záchranu dat, ale například pro vytvoření šifrovaného flash disku, který bude sloužit ke sdílení dat mezi Windows a Linuxem, je toto řešení nepoužitelné.

Z hlediska případného dalšího vývoje nebo použití v jiných projektech, je také minimálně diskutabilní použití některých technologií. Knihovna libbde je součástí většího projektu \emph{libyal}\footnote{https://github.com/libyal/libyal/wiki/Overview}, který obsahuje několik desítek různých knihoven. Jednou z nich je i knihovna \emph{libaes}\footnote{https://github.com/libyal/libcaes/wiki}, která poskytuje multiplatformní implementaci AES a kterou libbde používá pro dešifrování dat. Používání \uv{vlastních} implementací šifrování je obecně nedoporučováno a preferuje se použití standardních knihoven jako například \emph{libopenssl} nebo \emph{libgcrypt}, které mají teoreticky zaručit \uv{správnost} implementace kryptografických algoritmů. Použitá knihovna libaes například při dešifrování klíčů kvůli špatné implementaci AES-CCM vůbec nekontroluje přiložený MAC tag\footnote{https://github.com/libyal/libcaes/issues/2}.

Pro potenciální uživatele může být problematická také implementace v \emph{user space} pomocí FUSE\footnote{FUSE je interface pro práci se souborovými systémy v user space, bez potřeby programovat přímo v kernel space, a je tedy \uv{dostupný} i pro neprivilegované uživatele\cite{Singh2014}.}, které sice výrazně zjednodušuje vývoj, ale může mít velmi výrazný vliv na výkon --- zpomalení oproti implementaci v kernelu může nastat až o 83 \% a zatížení CPU může narůst až o 31 \%\cite{Vangoor2017}.

Pro případnou integraci do existujících nástrojů pro práci s úložnými zařízeními, může být teoreticky problém také licence --- libbde je dostupná pod licencí GNU LGPL verze 3, která je zpětně nekompatibilní s verzí 2 a použití takové knihovny by (i u nástrojů a knihoven a dostupných pod licencí GNU LGPL verze 2 a novější) automaticky změnilo licenci výsledného programu na GNU LGPL verze pouze 3\cite{GNU2019}.

Obecně lze říci, že knihovna libbde a s ní dostupné uživatelské nástroje jsou velmi užitečné pro případnou \uv{záchranu} dat ze zařízení zašifrovaného pomocí BitLockeru, při nemožnosti použít Windows, případně pro různou analýzu dat, ale bohužel nevhodné pro každodenní použití. Volba použitých technologií (FUSE, vlastní implementace kryptografických funkcí) z libbde také dělá nevhodného kandidáta na další rozšíření a případné začlenění do existujících aplikací a nástrojů.

\n{2}{Dislocker}


% ============================================================================ %
\cast{Projektová část}

\n{1}{Nadpis}

\n{2}{Podnadpis}


% ============================================================================ %
\nn{Závěr}
Text závěru


% ============================================================================ %
