% ============================================================================ %
% Encoding: UTF-8 (žluťoučký kůň úpěl ďábelšké ódy)
% ============================================================================ %

% ============================================================================ %
\nn{Úvod}
První odstavec pod nadpisem se neodsazuje, ostatní ano (pouze první řádek, odsazení vertikální mezy odstavci je typycké pro anglickou sazbu; czech babel toto respektuje, netřeba do textu přidávat jakékoliv explicitní formátování, viz ukázka sazby tohoto textu s následujícím odstavcem).

Formátování druhého odstavce. Text text text text text text text text text text text text.


% ============================================================================ %
\cast{Teoretická část}

\n{1}{BitLocker}
text

\n{2}{Diskový formát}

\todo{TODO: jak lépe říct on-disk format}

\n{3}{Hlavička}

Stejně jako u většiny diskových formátů, je i u BitLockeru na začátku disku takzvaná hlavička, která obsahuje základní informace o použitém formátu a jeho vlastnostech a také k jeho rychlé identifikaci. BitLocker hlavička zabírá celkem 512 bajtů a je u ní patrná inspirace u souborového systému NTFS. V tabulce \ref{tab:bitlocker-header} jsou zobrazeny jednotlivé (známé\footnote{Struktura formátu BitLocker není společností Microsoft nikde veřejně zcela kompletně zdokumentována, význam jednotlivých položek tedy nemusí být vždy přesně znám.}) položky hlavičky BitLockeru a pro srovnání také stejné položky v hlavičce souborového systému NTFS.

Struktura NTFS hlavičky je převzata z \cite{Carrier2005}, struktura BitLocker hlavičky je pak částečně převzata z \cite{j2YgJeTq3IrWJRcd}, částečně z \cite{Ferguson2006} a částečně výsledkem vlastního zkoumání.

\begin{table}[h]
\catcode`\-=12
\captionsetup{width=0.65\linewidth}
\caption{Porování položek hlaviček BitLocker a NTFS}
\label{tab:bitlocker-header}
\begin{center}
\centering
\begin{tabular}{|c|c|c|c|c|}
  \hline
   offset & velikost & BitLocker & NTFS \\ \hline
   0 & 3 & \multicolumn{2}{c|}{boot kód} \\ \hline
   3 & 8 & \multicolumn{2}{c|}{OEM název (signatura)} \\ \hline
   11 & 2 & \multicolumn{2}{c|}{počet bajtů na sektor} \\ \hline
   13 & 1 & \multicolumn{2}{c|}{počet sektorů na cluster} \\ \hline
   14 & 2 & \multicolumn{2}{c|}{rezervované sektory} \\ \hline
   16 & 4 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   21 & 1 & \multicolumn{2}{c|}{popisek média} \\ \hline
   22 & 18 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   40 & 8 & \multicolumn{2}{c|}{počet sektorů} \\ \hline
   48 & 8 & \multicolumn{2}{c|}{adresa prvního clusteru MFT} \\ \hline
   56 & 8 & \multicolumn{2}{c|}{kopie adresy prvního clusteru MFT} \\ \hline
   64 & 1 & \multicolumn{2}{c|}{velikost MFT entry} \\ \hline
   65 & 3 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   68 & 1 & \multicolumn{2}{c|}{velikost indexu} \\ \hline
   69 & 3 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   72 & 8 & \multicolumn{2}{c|}{NTFS serial number} \\ \hline
   80 & 4 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   84 & 76 & \multicolumn{2}{c|}{boot kód} \\ \hline
   160 & 16 & BitLocker GUID & \multirow{4}{*}{boot kód} \\ \cline{1-3}
   176 & 8 & offset první kopie FVE metadat & \\ \cline{1-3}
   184 & 8 & offset druhé kopie FVE metadat & \\ \cline{1-3}
   192 & 8 & offset třetí kopie FVE metadat & \\ \hline
   200 & 310 & \multicolumn{2}{c|}{boot kód}  \\ \hline
   510 & 2 & \multicolumn{2}{c|}{signatura (\texttt{0xaa55})} \\ \hline
\end{tabular}
\end{center}
\end{table}

\begin{center}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true, caption={BitLocker hlavička se zvýrazněnou signaturou, GUID a trojicí offsetů FVE metadat},label=lst:bitlocker-header]
00000000  eb 58 90 $\textcolor{blue}{2d 46 56 45 2d}$  46 53 2d 00 02 08 00 00  |.X.$\textcolor{blue}{-FVE-FS-}$.....|
00000010  00 00 00 00 00 f8 00 00  3f 00 ff 00 00 28 03 00  |........?....(..|
00000020  00 00 00 00 e0 1f 00 00  00 00 00 00 00 00 00 00  |................|
00000030  01 00 06 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000040  80 00 29 00 00 00 00 4e  4f 20 4e 41 4d 45 20 20  |..)....NO NAME  |
00000050  20 20 46 41 54 33 32 20  20 20 33 c9 8e d1 bc f4  |  FAT32   3.....|
00000060  7b 8e c1 8e d9 bd 00 7c  a0 fb 7d b4 7d 8b f0 ac  |{......|..}.}...|
00000070  98 40 74 0c 48 74 0e b4  0e bb 07 00 cd 10 eb ef  |.@t.Ht..........|
00000080  a0 fd 7d eb e6 cd 16 cd  19 00 00 00 00 00 00 00  |..}.............|
00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000a0  3b d6 67 $\textcolor{green}{49 29 2e d8 4a}$  $\textcolor{green}{83 99 f6 a3 39 e3 d0 01}$  |;.gI)..J....9...|
000000b0  $\textcolor{red}{00 50 19 02 00 00 00 00}$  $\textcolor{orange}{00 d0 c1 02 00 00 00 00}$  |.P..............|
000000c0  $\textcolor{yellow}{00 a0 73 03 00 00 00 00}$  00 00 00 00 00 00 00 00  |..s.............|
000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000100  0d 0a 52 65 6d 6f 76 65  20 64 69 73 6b 73 20 6f  |..Remove disks o|
00000110  72 20 6f 74 68 65 72 20  6d 65 64 69 61 2e ff 0d  |r other media...|
00000120  0a 44 69 73 6b 20 65 72  72 6f 72 ff 0d 0a 50 72  |.Disk error...Pr|
00000130  65 73 73 20 61 6e 79 20  6b 65 79 20 74 6f 20 72  |ess any key to r|
00000140  65 73 74 61 72 74 0d 0a  00 00 00 00 00 00 00 00  |estart..........|
00000150  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000190  00 00 00 00 00 00 00 00  78 78 78 78 78 78 78 78  |........xxxxxxxx|
000001a0  78 78 78 78 78 78 78 78  78 78 78 78 78 78 78 78  |xxxxxxxxxxxxxxxx|
*
000001e0  78 78 78 78 78 78 78 78  ff ff ff ff ff ff ff ff  |xxxxxxxx........|
000001f0  ff ff ff ff ff ff ff ff  ff ff ff 00 1f 2c 55 aa  |.............,U.|
00000200
\end{lstlisting}
\end{center}

Z pohledu identifkace BitLocker zařízení je nejdůležitější částí hlavičky 8 bajtů na offsetu 3, které se u NTFS formátu nazývají \emph{OEM název} a které slouží pro rychlou identifikace zařízení. V linuxových systémech se podobné identifikátory obvykle nazývají \emph{signatura}. \todo{TODO: To by asi chtělo citaci.} Pro BitLocker formát je (u všech verzí) signatura v ASCII podobě \texttt{-FVE-FS-}.

Pro další práci s BitLockerem není většina položek hlavičky zajímavá. Výjimku tvoří GUID identifkátor uložený na offsetu 160 (16 bajtů dlouhý UTF-8 string) a trojice \emph{uint32} hodnot na offsetech 176, 184 a 192, které obsahují umístění (jako relativní offset od začátku zkoumaného zařízení) tří bloků FVE metadat. Všechny tyto čtyři hodnoty jsou v BitLocker hlavičce umístěny na offsetech, které jsou v NTFS součástí \emph{bootcode}.

Umístění všech výše zmíněných \uv{důležitých} částí BitLocker hlavičky je zobrazeno na výpisu\todo{TODO: Jak tomu sakra říkat} \ref{lst:bitlocker-header}.


\n{3}{FVE metadata}

Samotná výše popsaná hlavička formátu BitLocker neobsahuje o samotném BitLockeru téměř žádné informace. Slouží především pro rychlou identifikaci zařízení jako zařízení šifrovaného pomocí technologie BitLocker. Všechny informace potřebné pro práci s tímto zařízením, tedy především způsob uložení dat, jejich umístění, způsob jakým jsou šifrovány a hlavně klíč pro jejich (de)šifrování je uložený na třech různých místech\footnote{Na offsetech přibližně ve 33 \%, 44 \% a 55 \% u testovaných BitLocker zařízeních.} definovaných v hlavičce. Jedná se o tři identické kopie\footnote{Tři kopie jsou zvoleny pravděpodobně jako záloha pro případ náhodného poškození metadat. Vzhledem k tomu, že bez kompletní nepoškozené kopie těchto metadat není možné data na zařízení dešifrovat, je vícenásobná záloha na místě.} takzvaných \emph{FVE metadat}.

FVE metadata se skládají z celkem tří částí -- hlavičky FVE bloku (\emph{FVE metadata block header}), samotné FVE hlavičky (\emph{FVE metadata header}) a různého množství FVE záznamů (\emph{FVE metadata entry}, které obsahují samotné klíče a další důležité informace\cite{j2YgJeTq3IrWJRcd}\footnote{Toto dělení zavádí Joachim Metz v \cite{j2YgJeTq3IrWJRcd}. Teoreticky by se daly dvě první části metadat spojit, protože na disku se nachází vždy hned za sebou, ale rozdělení dává smysl, protože první část se týká popisu samotných metadat (signatura, verze, umístění všech tří bloků), zatímco druhá část už obsahuje samotná metadata (GUID, čas vytvoření, použitý šifrovací algoritmus).}.

Důležité položky v obou hlavičkách, jejich velikosti a offsety (vztažené vůči začátku dané hlavičky) jsou uvedeny v tabulce \ref{tab:fve-header}. Kompletní struktura obou hlaviček je součástí přílohy \todo{TODO: odkaz na přílohu}.

\tab{Zjednodušená struktura FVE metadat}{tab:fve-header}{0.65}{|l|l|l|}{
  \hline
   \multicolumn{3}{|c|}{\textbf{Hlavička FVE bloku}} \\ \hline
   offset & velikost & popis  \\ \hline
   0 & 8 & signatura (\texttt{-FVE-FS-}) \\ \hline
   10 & 2 & verze (1 nebo 2) \\ \hline
   32 & 8 & offset první kopie FVE metadat \\ \hline
   40 & 8 & offset druhé kopie FVE metadat \\ \hline
   48 & 8 & offset třetí kopie FVE metadat  \\ \hline
   \multicolumn{3}{}{} \\ \hline
   \multicolumn{3}{|c|}{\textbf{FVE hlavička}} \\ \hline
   0 & 4 & velikost metadat (včetně záznamů) \\ \hline
   16 & 16 & GUID \\ \hline
   36 & 4 & šifrovací algoritmus \\ \hline
   40 & 8 & datum a čas vytvoření \\ \hline
}

Mezi pro nás zajímavé položky v hlavičce patří její celková velikost (včetně velikosti samotné hlavičky a velikosti za ní následujícíh záznamů), šifrovací algoritmus použitý pro zašifrování dat uložených na disku (možné algoritmy jsou popsány v části \ref{sec:algorithms}) a v některých případech může být užitečný i čas vytvoření, který je uložen ve formátu \texttt{FILETIME}\footnote{FILETIME je ve skutečnosti struktura sestávající ze dvou 32bit integer hodnot, které dohromady udávají počet 100 nanosekundových intervalů, které k danému datu uplynuly od 1. ledna 1601.\cite{Zxwr6wjYZUQ6z8Yp}}.

\n{3}{FVE záznamy}

Za výše uvedenou hlavičkou se nechází blíže nespecifikované množství FVE záznamů. Ty slouží v podstatě jako key-value úložiště pro jakékoli další \uv{informace}, které jsou pro práci s BitLockerem potřebné. Tím, že není třeba předem určeno, kolik takových záznamů bude za hlavičkou uloženo, je možné přidávat nové položky při zachování zpětné kompatibility\footnote{Celková největší možná velikost FVE metadat je 64 KiB (alespoň tedy tolik je pro FVEm metadata vyhrazeno na vytvořených BitLocker zařízeních), teoreticky je tedy možné mít až 64 KiB - 112 B metadat.}.

Jelikož známe celkovou velikost FVE metadat (je uvedena v hlavičce, viz tabulka \ref{tab:fve-header}) a celková velikosti hlaviček FVE metadat je pevná (64 a 48 bajtů), pro přečtení všech záznamů stačí číst data ve smyččce, dokud nedojdeme na konec metadat, nebo dokud následující záznam nemá nulovou velikost.

Struktutra FVE je relativně jednoduchá a je popsaná v tabulce \ref{tab:fve-entry}. Důležitou součástí je velikost záznamu, protože podle svého typu může mít různou délku.

\tab{Struktura FVE záznamu}{tab:fve-entry}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 2 & velikost záznamu \\ \hline
   2 & 2 & typ záznamu \\ \hline
   4 & 2 & typ hodnoty záznamu \\ \hline
   6 & 2 & verze (1) \\ \hline
   8 &  & data  \\ \hline
}

Typ a hodnota označují, co je v daném záznamu uloženo. Známé typy a hodnoty jsou popsány v tabulce \ref{tab:fve-entry-types}. U typů se typicky jedná buď o klíč (FVEK, VMK) nebo obecnou property, hodnota pak dále specifikuje, jak je daný typ uložen (zašifrovaný klíč, unicode string).

Způsob uložení dat záleží na tom, jaká konkrétní data jsou v záznamu uložena. U \uv{jednoduchých} záznamů, jako je například popisek je v datech uložen textový řetězec uložený v kódování UTF-16, u \uv{složitějších} záznamů, jako jsou například klíče, mají data vlastní strukturu včetně dalších záznamů.

\begin{table}[h]
\catcode`\-=12
\captionsetup{width=0.65\linewidth}
\caption{Známé typy FVE záznamů}
\label{tab:fve-entry-types}
\begin{center}
\centering
\begin{tabular}{|l|l|c|l|l|}
  \cline{1-2} \cline{4-5}
   \multicolumn{2}{|c|}{\textbf{Typy}} &  & \multicolumn{2}{|c|}{\textbf{Hodnoty}} \\ \cline{1-2} \cline{4-5}
   typ & popis &  & typ & popis \\ \cline{1-2} \cline{4-5}
   0 & property & & 0 & smazáno \\ \cline{1-2} \cline{4-5}
   1 & VMK & & 1 & klíč \\ \cline{1-2} \cline{4-5}
   2 & FVEK & & 2 & string \\ \cline{1-2} \cline{4-5}
   7 & popisek & & 5 & AES-CCM šifrovaný klíč \\ \cline{1-2} \cline{4-5}
   15 & hlavička disku\footnotemark & & 6 & TPM klíč \\ \cline{1-2} \cline{4-5}
   \multicolumn{2}{c}{} & & 8 & VMK \\ \cline{4-5}
   \multicolumn{2}{c}{} & & 15 & offset a velikost \\ \cline{4-5}
   

\end{tabular}
\end{center}
\end{table}

\footnotetext{Umístění a velikost NTFS hlavičky otevřeného zařízení. Odpovídá hodnotě 15. Podrobnější informace o umístění NTFS hlavičky na šifrovaném zařízení jsou v části \ref{sec:data-map}.}

Příklad \uv{jednoduchého} záznamu je uveden na obrázku \ref{fig:fve-entry-desc}, kde vidíme záznam typu \emph{description}. Ten v podstatě obsahuje jméno počítače, na kterém bylo dané BitLocker zařízení vytvořeno a také datum vytvoření. Můžeme tedy vidět, že toto konkrétní BitLocker zařízení bylo vytvořeno na počítači \texttt{DESKTOP-NPM7RCA} a to 3. února 2019. Tato informace je uloženo jako standardní string v kódování UTF-16. Kromě tohoto stringu jsou pak na obrázku zvýrazněny i další údaje: velikost celého záznamu (64 bajtů), jeho typ (7 -- popisek) a hodnota (2 -- string) a verze (1).


\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
		\caption{Příklad FVE záznamu typu \uv{description} (popisek)}
		\label{fig:fve-entry-desc}

\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
02195070  $\textcolor{red}{40 00}$ $\textcolor{orange}{07 00}$ $\textcolor{yellow}{02 00}$ $\textcolor{green}{01 00}$  $\textcolor{blue}{44 00 45 00 53 00 4b 00}$ |@.......$\textcolor{blue}{D.E.S.K.}$|
02195080  $\textcolor{blue}{54 00 4f 00 50 00 2d 00}$  $\textcolor{blue}{4e 00 50 00 4d 00 37 00}$ |$\textcolor{blue}{T.O.P.-.N.P.M.7.}$|
02195090  $\textcolor{blue}{52 00 43 00 41 00 20 00}$  $\textcolor{blue}{47 00 3a 00 20 00 32 00}$ |$\textcolor{blue}{R.C.A. .G.:. .2.}$|
021950a0  $\textcolor{blue}{2f 00 33 00 2f 00 32 00}$  $\textcolor{blue}{30 00 31 00 39 00}$ 00 00 |$\textcolor{blue}{/.3./.2.0.1.9.}$..|
\end{lstlisting}

\end{figure}

U jednoduchého zařízení --- v našem případě USB flash disku --- se bude obvykle vyskytovat pouze pět záznamů a to již výše zmíněný popisek, dvojice záznamů typu VMK, jeden záznam typu FVEK (o obou více v části \ref{sec:keys} a jeden záznam obsahující informace o umístění hlavičky disku (o tomto záznamu více v části \ref{sec:data-map}).



\n{2}{Klíče}\label{sec:keys}

\n{3}{Volume Master Key}

\n{3}{Full Volume Encryption Key}

\n{2}{Šifrovaná data}

\n{3}{Použité šifrovací algoritmy}\label{sec:algorithms}

\n{3}{Způsob uložení data}\label{sec:data-map}

\n{3}{Postup při dešifrování}

\n{1}{Existující řešení pro práci s BitLockerem v Linuxu}

\n{2}{libbde}

\n{2}{Dislocker}


\n{1}{Další nadpis}
Tato sekce obsahuje ukázku vložení obrázku (Obr. \ref{fig:logo}).

% Obrázek lze vkládat pomocí následujícího zjednodušeného stylu, nebo klasickým LaTex způsobem
% Pozor! Obrázek nesmí obsahovat alfa kanál (průhlednost). Jde to proti standardu PDF/A.
\obr{Popisek obrázku}{fig:logo}{0.5}{graphics/logo/fai_logo_cz.png}


\n{2}{Podnadpis}
Tato sekce obsahuje ukázku vložení tabulky (Tab. \ref{tab:priklad}).

% Tabulku lze vkládat pomocí následujícího zjednodušeného stylu, nebo klasickým LaTex způsobem
\tab{Popisek tabulky}{tab:priklad}{0.65}{|l|c|c|c|c|c|r|}{
  \hline
   & 1 & 2 & 3 & 4 & 5 & Cena [Kč] \\ \hline
  \emph{F} & (jedna) & (dva) & (tři) & (čtyři) & (pět) & 300 \\ \hline
}

\n{3}{Podpodnadpis}

\n{3}{Podpodnadpis}
Citace knihy.


% ============================================================================ %
\cast{Projektová část}

\n{1}{Nadpis}

\n{2}{Podnadpis}


% ============================================================================ %
\nn{Závěr}
Text závěru


% ============================================================================ %
