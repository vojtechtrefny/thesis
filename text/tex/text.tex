% ============================================================================ %
% Encoding: UTF-8 (žluťoučký kůň úpěl ďábelšké ódy)
% ============================================================================ %

% ============================================================================ %
\nn{Úvod}

Šifrování dat je jedním ze základních způsobů jejich ochrany obzvlášť na přenosných zařízeních, jako jsou notebooky nebo externí disky. Bohužel v~současné době neexistuje žádné řešení, které by spolehlivě fungovalo v~heterogenním prostředí a v~případě externích disků, které mají být používány jak v~prostředí Microsoft Windows, tak v~linuxovém prostředí, je třeba se spoléhat buď na nástroje třetích stran, nebo na ne vždy funkční či uživatelsky přívětivá řešení, která v~jednom prostředí zajistí podporu pro nativní šifrování prostředí druhého.

Cílem této práce je prozkoumat technologii BitLocker, která představuje nativní implementaci šifrování disku v~operačním systému Microsoft Windows, a podle možností implementovat nové, případně upravit stávající nástroje pro práci s~blokovými zařízeními v~prostředí operačního systému GNU/Linux tak, aby uživatel byl schopen s~BitLocker zařízeními pracovat stejně jako se zařízeními šifrovanými pomocí nativních linuxových technologií.

Teoretická část této práce v~první kapitole popisuje šifrování disku obecně. V~druhé kapitole se zaměřuje na samotnou technologii BitLocker, jí používané kryptografické funkce, diskový formát, druhy použitých klíčů a způsoby jejich ochrany a způsobem uložení dat na šifrovaném zařízení. Třetí kapitola pak představuje existující řešení pro práci s~BitLockerem v~linuxovém prostředí a jejich přednosti a nedostatky.

Praktická část této práce ve čtvrté kapitole obecně představuje technologie a možná řešení pro podporu BitLocker zařízení v~linuxovém prostředí. Pátá kapitola se zaměřuje na kernelový ovladač Device Mapper, který je možno použít pro práci se šifrovanými blokovými zařízeními. V~šesté kapitole je popsán nově vytvořený nástroj pracující s~BitLocker zařízeními a BitLocker metadaty. V~sedmé části je pak představen systémový démon UDisks, který poskytuje nástroje pro práci s~blokovými zařízeními koncovým uživatelům systému, a jsou zde také popsány úpravy, které bylo třeba provést, aby byla podpora BitLocker zařízení dostupná v~grafickém rozhraní.


% ============================================================================ %
\cast{Teoretická část}

\n{1}{Šifrování disku}\label{sec:fde}

Šifrování disku, anglicky \emph{Full Disk Encryption} (FDE) nebo \emph{Whole Disk Encryption} je proces, při kterém dochází k~šifrování všech dat na disku, včetně systémových souborů operačního systému. K~datům na disku pak má uživatel přístup pouze po úspěšné autentizaci. Data na disku zůstávají stále šifrovaná a teprve, když uživatel potřebuje číst či zapisovat data, jsou potřebné sektory disku transparentně před čtením dešifrovány a před zápisem opět zašifrovány. Šifrování disku může být řešeny softwarově, ale i hardwarově v~podobě disků, které šifrování implementují ve svém firmwaru.

Kromě šifrování disku existují i další technologie, které šifrují pouze části dat ulo\-že\-ných na blokových zařízeních. Příkladem může být šifrování v~podobě speciálních šifrovaných kontejnerů, šifrování pouze vybraných diskových oddílů nebo jen je\-dno\-tli\-vých souborů či složek. Pouze šifrování celého disku však zaručuje maximální možnou bez\-peč\-nost, kdy jsou šifrována všechna citlivá data včetně například odkládacích oddílů (swap), dočasných souborů a metadat o~ši\-fro\-va\-ných souborech.\cite{Scarfone2007}

Ani šifrování disku však nepředstavuje stoprocentní ochranu dat. Pokud útočník získá přístup k~počítači s~běžícím systémem, může z~jeho paměti získat šifrovací klíč, který v~ní musí být dobu běhu systému uložen. Ačkoli se obecně předpokládá, že po přerušení napájení jsou data z~operační paměti okamžitě ztracena, výzkumníci z~Princetonské univerzity prokázali, že data je možné přečíst ještě několik sekund po přerušení napájení, a v~případě zchlazení paměti na -50 $^{\circ}$C, je po deseti minutách poškozeno dokonce méně než jedno procento dat. Díky tomu je možné po přendání paměťových modulů do jiného stroje přečíst jejich obsah a nalézt v~něm uložené klíče.\cite{Halderman20090501}

\n{1}{BitLocker}

BitLocker představuje technologii pro šifrování disku od společnosti Microsoft. BitLocker byl představen v~roce 2006 a poprvé jej uživatelé mohli použít v~ope\-rač\-ním systému Windows Vista. Původním cílem BitLockeru byla ochrana dat na odcizených nebo ztracených přenosných počítačích.\cite{Ferguson2006} BitLocker dokáže ochránit všechna data ope\-rač\-ní\-ho systému Windows s~výjimkou systémového oddílu, který obsahuje Windows Boot Manager.\cite{Hall20191}

V~této části si stručně představíme kryptografické funkce, které BitLocker používá, formát uložení dat a metadat na disku, používané šifrovací klíče a způsoby jejich ochrany.

\n{2}{Použité kryptografické funkce}\label{sec:algorithms}

BitLocker používá několik různých kryptografických funkcí a to jak pro šifrování samotných na disku uložených dat, tak pro ochranu klíčů pro jejich (de)šifrování, které jsou uloženy v~metadatech. V~této kapitole si představíme trojici algoritmů používaných v~různých verzích BitLockeru pro šifrování dat na disku: AES-CBC a jeho rozšíření Elephant difuzér a AES-XTS a také algoritmus AES-CCM, kterým jsou zašifrovány BitLockerem používané klíče a stručně si také představíme pro BitLocker specifickou funkci pro odvození klíče z~uživatelem zadávaného hesla.

\n{3}{AES-CBC}\label{sec:aes-cbc}

AES-CBC je standardní široce používaná bloková šifra, která je ve starších verzích BitLockeru používaná pro šifrování dat uložených na šifrovaném zařízení.

Původní návrh CBC módu byl patentován v~roce 1978\cite{Ehrsam1978} a řešil problém staršího ECB módu, při jehož použití vzniká zašifrováním dvou stejných bloků otevřeného textu stejný šifrovaný text. Tento problém CBC řeší tak, že každý blok otevřeného textu je napřed XORován s~předchozím šifrovaným blokem. Standardně tedy šifrování v~CBC módu probíhá následovně

\begin{align}
C_i = E(K, P_i \oplus C_{i-1}) \quad \text{pro}\ i = 1, \dots, k~\\ \nonumber
\end{align}

kde $C_i$ je výsledný šifrovaný blok, $K$ klíč, $P_i$ blok otevřeného textu a $C_{i-1}$ předchozí šifrovaný blok. Protože pro první blok textu neexistuje žádný předchozí blok $C_0$, se kterým by mohl být XORován, zavádí se nová hodnota, takzvaný \emph{inicializační vektor}, který se použije pro první blok místo předchozího šifrovaného bloku.\cite{Kohnoc2010}

\obr{Schéma šifrování pomocí blokové šifry v~CBC módu\cite{WikimediaCBC}}{fig:cbc-mode}{0.85}{img/cbc.png}

Pro BitLocker je v~případě AES-CBC použito jako inicializační vektor číslo sektoru, navíc ještě zašifrované stejným klíčem, který je využit i pro šifrování textu.

XORování s~předchozím blokem zavádí do AES-CBC potenciální slabinu, kdy při znalosti umístění bloku otevřeného textu lze pozměnit předchozí blok tak, aby v~následujícím bloku došlo k~přehození hodnoty určeného bitu. Tím se sice znehodnotí informace uložené ve změněném bloku (který bude dešifrován na náhodná data), ale můžeme tak změnit důležitou informaci obsaženou v~bloku následujícím podle potřeby útočníka.\cite{Regalado2013}

U~BitLockeru může tento útok představovat problém, pokud útočník zná přesné rozložení dat na disku, což je možné obzvlášť u~počítačů instalovaných z~předpřipravených obrazů. Útočník pak může změnit některé důležité části systému, například spouštěné binární soubory.\cite{Ferguson2006,Rosendorf2013} AES-CBC neobsahuje žádnou autentizační část a nechrání tedy před podobnými (ale ani náhodnými, například v~případě poškození disku) změnami šifrovaných dat tak, jako jiné šifry, jako například AES-CCM.

\n{3}{Elephant difuzér}

Elephant difuzér je nový algoritmus navržený pro původní variantu BitLockeru rozšiřující AES-CBC tak, aby byly odstraněny potenciální bezpečnostní problémy AES-CBC při použití pro šifrování blokových zařízeních, popsané v~\ref{sec:aes-cbc}\cite{Ferguson2006}.

\obr{Schéma šifrování sektoru pomocí AES-CBS s~Elephant difuzérem\cite{Ferguson2006,Kumar2008}}{fig:bitlocker-difuzer}{0.75}{img/bitlocker-difuzer.png}

Zjednodušené schéma fungování šifrování pomocí AES-CBC s~Elephant difuzérem je znázorněno na obrázku \ref{fig:bitlocker-difuzer}. Základem je použití dvou různých klíčů --- TWEAK klíče pro difuzér a FVEK pro samotné AES-CBC. Podle \cite{Ferguson2006} je tak zajištěno, že výsledek bude minimálně stejně bezpečný jako samotný AES-CBC a eliminuje se tak potenciální problém s~použitím nové nevyzkoušené šifry.

Prvním krokem při použití difuzéru je odvození takzvaného sektorového klíče $K_s$. Ten se získá z~čísla sektoru a TWEAK klíče ($K_{TWEAK}$) následujícím způsobem:

\begin{align}
K_s = E(K_{TWEAK}, e(s)) \parallel E(K_{TWEAK}, e'(s)) \\ \nonumber
\end{align}

kde $e(s)$ je číslo sektoru uložené jako 64bit little endian (s~vynulovanými nepoužitými bity) a $e'(s)$ je stejné jako $e(s)$, kromě posledního bajtu, který je nastaven na 128 (0x80). Výsledný 128bit klíč je pak následně podle potřeby zřetězen, aby odpovídal délce šifrovaného sektoru.\cite{Ferguson2006,Rosendorf2013,Kumar2008}

Otevřený text je pak následně XORován s~takto získaným klíčem a dále zpracován pomocí dvojice difuzérů $A$ a $B$.

Přesný popis obou difuzérů je k~dispozici v~\cite{Ferguson2006}, zde si pouze stručně naznačíme jejich funkčnost, jejíž cílem je rozprostřít informaci po celé délce šifrovaného sektoru.

Difuzéry $A$ (\ref{difuzer-a}) a $B$ (\ref{difuzer-b}) fungují při šifrování dat následovně:

\begin{align}
\mathbf{for}\ i &= n \cdot A_{cycles} - 1,  \dots 2, 1, 0 \nonumber \\
	&d_i \leftarrow d_i - (d_{i-2} \oplus (d_{i-5} \lll R^{(a)}_{i \mod 4})) \label{difuzer-a} \\
\mathbf{for}\ i &= n \cdot B_{cycles} - 1,  \dots 2, 1, 0 \nonumber \\
	&d_i \leftarrow d_i - (d_{i+2} \oplus (d_{i+5} \lll R^{(b)}_{i \mod 4})) \label{difuzer-b} \\
\nonumber
\end{align}

kde $n$ je počet slov v~sektoru, $(d_0, d_1,\dots,d_{n-1}$) jsou slova daného sektoru, $i$ je řídící proměnná cyklu, $A_{cycles}$ a $B_{cycles}$ je počet opakování difuzérů $A$ a $B$ (u~BitLockeru je $A_{cycles} := 5$ a $B_{cycles} := 3$) a $R^{(a)}$ a $R^{(b)}$ počet posunutí doleva ($\lll$) v~jednotlivých krocích.\cite{Ferguson2006}


\n{3}{AES-XTS}\label{sec:aes-xts}

AES-XTS je speciálně navržená bloková šifra pro šifrování dat uložených na blokových zařízeních. Jedná se o~rozšíření původního XEX módu, jehož funkcionalita je naznačena na obrázku \ref{fig:xex-mode}, o~takzvaný \emph{ciphertext stealing}, který rozšiřuje XEX mód o~možnost šifrovat data i o~jiné délce, než jsou násobky 128bit.\cite{Dworkin2010} Vzhledem k~tomu, že u~blokových zařízení se standardně používá délka sektoru 512 nebo 4096 bajtů, jedná se v~tomto případě prakticky o~XEX mód.

\obr{Schéma šifrování pomocí blokové šifry v~XEX módu\cite{WikimediaXEX}}{fig:xex-mode}{0.90}{img/xex.png}

Šifrování jednoho bloku pomocí AES-XTS pak probíhá následujícím způsobem

\begin{align}
T &= E (K_2 , i) \otimes \alpha^j \\
C &= E (K_1 , P \oplus T) \oplus T \\ \nonumber
\end{align}

kde $E$ je použitá šifrovací funkce (v~tomto případě AES), $C$ je výsledný šifrovaný blok, $P$ blok otevřeného textu, $K_1$ a $K_2$ jsou klíče, $i$ číslo sektoru, $\alpha^j$ prvek $GF(2^{128})$ odpovídající polynomiálnímu $x$ (například $10_2$), přičemž $GF$ je Galoisovo těleso.\cite{IEEE2008}

Z~výše uvedeného vyplývá, že pro AES-XTS jsou použity dva různé klíče --- jeden pro šifrování čísla sektoru (inicializačního vektoru) a druhý pro šifrování samotného bloku otevřeného textu. Proto jsou klíče pro AES-XTS dvakrát větší, než kolik by vyžadovalo samotné AES. Klíč pro 128bit AES-XTS tedy bude mít celkovou délku 256 bitů.

Stejně jako AES-CBC zmíněný v~části \ref{sec:aes-cbc}, ani AES-XTS neobsahuje žádnou autentizaci a nechrání tedy před změnami šifrovaného textu.

\n{3}{AES-CCM}

Poslední z~šifrovacích funkcí použitých v~BitLockeru je AES s~CCM módem, která je použita pouze v~rámci metadat na ochranu uložených klíčů. AES-CCM představuje zástupce šifer používaných pro takzvané autentizované šifrování, které zajišťují jak integritu, tak důvěrnost dat. Toho je typicky docíleno spojením šifrování a MAC.\cite{ISO2009}

CCM mód představuje kombinaci dvou existujících technologií --- CTR módu, který zajišťuje samotné šifrování a CBC-MAC, který zajišťuje autentizaci, přičemž pro obě části šifry se používá stejný klíč.

Postup při dešifrování a verifikaci, který nás při práci s~BitLocker zařízeními zajímá nejvíce, je následující: Na vstupu funkce jsou zašifrovaná data, řetězec pro ve\-ri\-fi\-ka\-ci (MAC tag) a nonce použité při generování šifrovaných dat. Šifrovaný text je dešifrován v~CTR módu, jehož výsledkem jsou otevřená data a MAC. Následně se pomocí CBC-MAC ověří dešifrovaný MAC a pokud je verifikace úspěšná, vrátí CCM funkce dešifrovaná data.\cite{Dworkin2004}

Ačkoli je CCM mód obvykle používán pro zajištění, že s~šifrovanými daty nebylo nijak manipulováno (jako například v~IPsec\cite{Housley2005}), v~BitLockeru lze verifikační krok využít také k~rychlému zjištění, zda bylo uživatelem zadáno správné heslo, protože v~případě použití nesprávného hesla MAC autentizace také selže a není tak třeba složitě zjišťovat, zda dešifrovaný heslem chráněný klíč je ve skutečnosti správný či nikoli.

AES-CCM bylo kvůli zajištění autentizace také zvažováno pro šifrování samotných uložených dat. Problémem v~tomto případě je ale fakt, že šifrovaná dat nemohou být větší, než data otevřená --- potřebný MAC tag není možné uložit společně s~šifrovaným sektorem a ukládání MAC tagu do jiného sektoru, například společně s~MAC tagy pro další sektory, porušuje atomicitu zápisu sektoru a v~případě poškození sektoru s~MAC tagy bude ztraceno více sektorů s~daty, která by pak nebylo možné kvůli chybějícím MAC tagům při dešifrování ověřit.\cite{Ferguson2006}

\n{3}{Odvození klíče z~hesla}\label{sec:kdf}

Jedním z~problémů, které je třeba řešit v~případech, kdy je v~kryptografii použito heslo zadávané uživatelem, je převedení tohoto hesla na klíč použitelný pro vybranou šifrovací funkci, v~našem případě AES-CCM, která v~BitLockeru slouží k~ochraně na disku uložených klíčů. Obecně se v~těchto případech používají speciální funkce pro odvození klíče (KDF, Key Derivation Function), které z~hesla odvodí klíč o~požadované délce. Obvyklým postupem je zkombinování hesla s~unikátní solí za použití hashovací funkce, kdy přidání soli ztěžuje možnost vytvoření předpočítaných tabulek hesel. Dalším používaným stupněm ochrany je pak přidání určitého počtu iterací, které je třeba pro odvození klíče provést. Tím se celé odvození klíče zpomaluje a teoreticky se tak zvyšuje odolnost proti útokům hrubou silou.\cite{Kaliski2000}

Ačkoli existují standardizované funkce pro odvození klíče z~hesla, jako například PBKDF2 definovaná v~\cite{Kaliski2000}, Microsoft pro BitLocker zavedl vlastní funkci postavenou nad hashovací funkcí SHA256\cite{FIPS180-4} s~pevným počtem iterací.

Prvním krokem pro odvození klíče je zkonstruování struktury uvedené na obrázku \ref{fig:bitlocker-kdf}.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true, xleftmargin=.35\textwidth, xrightmargin=.35\textwidth]
uint8_t last_sha256[32];
uint8_t initial_sha256[32];
uint8_t salt[8];
uint64_t count;
\end{lstlisting}
		\caption{Struktura pro odvození hesla z klíče podle \cite{Metz2011}}
		\label{fig:bitlocker-kdf}
\end{figure}

Následně se počet iterací (\texttt{count}) a poslední spočtená hodnota hashe celé struktury \texttt{last$\_$sha256} nastaví na nuly. Z~uživatelem zadaného hesla se spočte SHA256 a z~tohoto výsledku se spočte ještě jednou SHA256 a nastaví se jako výchozí hodnota hashe (\texttt{initial$\_$sha256}). Potřebná sůl (\texttt{salt}) je uložena v~metadatových záznamech u~VMK, který je chráněn daným heslem (viz \ref{sec:vmk}).

Dalším krokem je již samotná iterace, kdy se spočte SHA256 hash celé struktury a výsledek se uloží do proměnné \texttt{last$\_$sha256}. Zároveň se zvýší čítač iterací o~jedna a vše se opakuje celkem 1048576 (0x100000) krát. Poslední hodnota uložená v~\texttt{last$\_$sha256} po provedení všech iterací, je pak hledaný odvozený klíč.\cite{Metz2011,Agostini2019}

\n{3}{Inicializační vektory}\label{sec:iv}

Ve výše uvedených popisech šifrovacích funkcí je několikrát zmíněn inicializační vektor. Ten se používá u~blokových šifer, které pro zvýšení bezpečnosti před šifrováním XORují otevřený text s~předchozím šifrovaným blokem. Inicializační vektor v~tomto případě nahrazuje nultý šifrovaný blok pro první blok otevřeného textu.

Inicializační vektor je možné definovat různými způsoby jako je například fixní IV (v~tom případě ale dojde ke stejnému problému jako u~ECB módu --- dva stejně začínající sektory vytvoří stejný šifrovaný text), náhodný IV, posloupnost čísel nebo IV generovaný z~unikátního čísla nonce (z~anglického \uv{\emph{n}umber used \emph{once}}).\cite{Kohnoc2010}

V~BitLockeru jsou použity pro výše zmíněné šifry následující inicializační vektory:
\begin{itemize}
	\item u~AES-CBC číslo sektoru zašifrované pomocí AES-ECB s~klíčem použitým pro šifrování dat,
	\item u~AES-XTS pouze jednoduché číslo sektoru uložené jako 128bit little indian a
	\item u~AES-CCM nonce uložené společně s~klíčem, který je pomocí AES-CCM zašifrován. \cite{Metz2011}
\end{itemize}

\n{2}{Diskový formát}

Pro samotnou práci s~BitLocker zařízením v~linuxovém prostředí je nejdůležitější formát, tedy způsob, jakým jsou na disku uložena data. Protože je pomocí BitLockeru možné vytvořit šifrovaný flash disk, který lze použít na jiném počítači pouze za znalosti hesla, je zřejmé, že někde na samotném disku jsou uložena všechna potřebná metadata pro jeho \uv{odemčení}\footnote{U šifrovaných úložných zařízení se běžně používá termín \emph{odemčení} pro jeho \uv{připravení} pro čtení. Odemčení dává větší smysl, než dešifrování, protože data se dešifrují až při jejich čtení, jak již bylo vysvětleno v~části \ref{sec:fde}. Při odemčení se tedy pouze z~metadat (nebo z~jiného hardwaru, jako například TPM) získá (de)šifrovací klíč a připraví se (virtuální) zařízení, ze kterého lze číst data v~otevřené podobě.} v~(alespoň částečně) otevřené podobě\footnote{Například populární nástroj TrueCrypt/VeraCrypt na zašifrovaném disku žádná metadata v~otevřené podobě nemá.\cite{Broz20141}}.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
		\begin{bytefield}[bitwidth=1.7em]{24}
		  \bithead{1}{16} &
		  \bithead{3}{68760} &
		  \bithead{2}{128} &
		  \bithead{3}{21440} &
		  \bithead{2}{128} &
		  \bithead{3}{22632} &
		  \bithead{2}{128} &
		  \bithead{3}{91568}\\
		  \bitbox{1}{Hl.} &
		  \bitbox{3}{Data} &
		  \bitbox{2}{FVE 1} &
		  \bitbox{3}{Data} &
		  \bitbox{2}{FVE 2} &
		  \bitbox{3}{Data} &
		  \bitbox{2}{FVE 3} &
		  \bitbox{3}{Data} & \\
		\end{bytefield}
		\caption{Zjednodušené schéma struktury 100 MiB BitLocker zařízení}
		\label{fig:bitlocker-device}
\end{figure}

Na obrázku \ref{fig:bitlocker-device} je nastíněna zjednodušená struktura uložení dat a metadat na zařízení šifrovaném pomocí BitLockeru. Na začátku zařízení se nachází 8 KiB velká hla\-vič\-ka (podrobněji popsána v~části \ref{sec:header}) obsahující základní data pro jeho identifikaci a mezi zašifrovanými daty jsou uloženy tři kopie dalších metadat, každá o~velikosti 64 KiB\footnote{Velikosti odpovídají místu, které je pro daná metadata na zařízení vyhrazeno. Ve skutečnosti mohou být metadata mnohem menší.} (podrobněji popsány v~části \ref{sec:fve-metadata}). Čísla nad jednotlivými \uv{částmi} schématu odpovídají jejich velikosti v~sektorech pro testovací zařízení o~velikosti 100 MiB, které bylo vytvořeno ve Windows 10.

\n{3}{Hlavička}\label{sec:header}

Stejně jako u~většiny diskových formátů, je i u~BitLockeru na začátku disku takzvaná hlavička, která obsahuje základní informace o~použitém formátu a jeho vlastnostech a také slouží k~jeho rychlé identifikaci.

BitLocker hlavička zabírá celkem 512 bajtů a je u~ní patrná inspirace u~souborového systému NTFS. V~tabulce \ref{tab:bitlocker-header} jsou zobrazeny jednotlivé známé položky hlavičky BitLockeru a pro srovnání také stejné položky v~hlavičce souborového systému NTFS. Struktura formátu BitLocker není společností Microsoft nikde veřejně zcela kompletně zdokumentována, význam jednotlivých položek tedy nemusí být vždy přesně znám.

Popis struktury NTFS hlavičky je převzat z~\cite{Carrier2005}, popis struktury BitLocker hlavičky je pak částečně převzata z~\cite{Metz2011}, částečně z~\cite{Ferguson2006}, částečně z~\cite{Kornblum2009} a částečně výsledkem vlastního zkoumání.

\begin{table}[h]
\catcode`\-=12
\captionsetup{width=0.65\linewidth}
\caption{Porování položek hlaviček BitLocker a NTFS}
\label{tab:bitlocker-header}
\begin{center}
\centering
\begin{tabular}{|c|c|c|c|c|}
  \hline
   offset & velikost & BitLocker & NTFS \\ \hline
   0 & 3 & \multicolumn{2}{c|}{boot kód} \\ \hline
   3 & 8 & \multicolumn{2}{c|}{OEM název (signatura)} \\ \hline
   11 & 2 & \multicolumn{2}{c|}{počet bajtů na sektor} \\ \hline
   13 & 1 & \multicolumn{2}{c|}{počet sektorů na cluster} \\ \hline
   14 & 2 & \multicolumn{2}{c|}{rezervované sektory} \\ \hline
   16 & 4 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   21 & 1 & \multicolumn{2}{c|}{popisek média} \\ \hline
   22 & 18 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   40 & 8 & \multicolumn{2}{c|}{počet sektorů} \\ \hline
   48 & 8 & \multicolumn{2}{c|}{adresa prvního clusteru MFT} \\ \hline
   56 & 8 & \multicolumn{2}{c|}{kopie adresy prvního clusteru MFT} \\ \hline
   64 & 1 & \multicolumn{2}{c|}{velikost MFT entry} \\ \hline
   65 & 3 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   68 & 1 & \multicolumn{2}{c|}{velikost indexu} \\ \hline
   69 & 3 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   72 & 8 & \multicolumn{2}{c|}{NTFS serial number} \\ \hline
   80 & 4 & \multicolumn{2}{c|}{nepoužito} \\ \hline
   84 & 76 & \multicolumn{2}{c|}{boot kód} \\ \hline
   160 & 16 & BitLocker GUID & \multirow{4}{*}{boot kód} \\ \cline{1-3}
   176 & 8 & offset první kopie FVE metadat & \\ \cline{1-3}
   184 & 8 & offset druhé kopie FVE metadat & \\ \cline{1-3}
   192 & 8 & offset třetí kopie FVE metadat & \\ \hline
   200 & 310 & \multicolumn{2}{c|}{boot kód}  \\ \hline
   510 & 2 & \multicolumn{2}{c|}{signatura (\texttt{0xaa55})} \\ \hline
\end{tabular}
\end{center}
\end{table}

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000  eb 58 90 $\textcolor{blue}{2d 46 56 45 2d}$  46 53 2d 00 02 08 00 00 |.X.$\textcolor{blue}{-FVE-FS-}$.....|
00000010  00 00 00 00 00 f8 00 00  3f 00 ff 00 00 28 03 00 |........?....(..|
00000020  00 00 00 00 e0 1f 00 00  00 00 00 00 00 00 00 00 |................|
00000030  01 00 06 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
00000040  80 00 29 00 00 00 00 4e  4f 20 4e 41 4d 45 20 20 |..)....NO NAME  |
00000050  20 20 46 41 54 33 32 20  20 20 33 c9 8e d1 bc f4 |  FAT32   3.....|
00000060  7b 8e c1 8e d9 bd 00 7c  a0 fb 7d b4 7d 8b f0 ac |{......|..}.}...|
00000070  98 40 74 0c 48 74 0e b4  0e bb 07 00 cd 10 eb ef |.@t.Ht..........|
00000080  a0 fd 7d eb e6 cd 16 cd  19 00 00 00 00 00 00 00 |..}.............|
00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
000000a0  3b d6 67 $\textcolor{green}{49 29 2e d8 4a}$  $\textcolor{green}{83 99 f6 a3 39 e3 d0 01}$ |;.gI)..J....9...|
000000b0  $\textcolor{red}{00 50 19 02 00 00 00 00}$  $\textcolor{orange}{00 d0 c1 02 00 00 00 00}$ |.P..............|
000000c0  $\textcolor{yellow}{00 a0 73 03 00 00 00 00}$  00 00 00 00 00 00 00 00 |..s.............|
000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
*
00000100  0d 0a 52 65 6d 6f 76 65  20 64 69 73 6b 73 20 6f |..Remove disks o|
00000110  72 20 6f 74 68 65 72 20  6d 65 64 69 61 2e ff 0d |r other media...|
00000120  0a 44 69 73 6b 20 65 72  72 6f 72 ff 0d 0a 50 72 |.Disk error...Pr|
00000130  65 73 73 20 61 6e 79 20  6b 65 79 20 74 6f 20 72 |ess any key to r|
00000140  65 73 74 61 72 74 0d 0a  00 00 00 00 00 00 00 00 |estart..........|
00000150  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|
*
00000190  00 00 00 00 00 00 00 00  78 78 78 78 78 78 78 78 |........xxxxxxxx|
000001a0  78 78 78 78 78 78 78 78  78 78 78 78 78 78 78 78 |xxxxxxxxxxxxxxxx|
*
000001e0  78 78 78 78 78 78 78 78  ff ff ff ff ff ff ff ff |xxxxxxxx........|
000001f0  ff ff ff ff ff ff ff ff  ff ff ff 00 1f 2c 55 aa |.............,U.|
00000200
\end{lstlisting}
		\caption{BitLocker hlavička se zvýrazněnou signaturou, GUID a trojicí offsetů FVE metadat}
		\label{fig:bitlocker-header}
\end{figure}

Z~pohledu identifikace BitLocker zařízení je nejdůležitější částí hlavičky 8 bajtů na offsetu 3, které se u~NTFS formátu nazývají \emph{OEM název} a které slouží pro rychlou identifikace zařízení. V~linuxových systémech se podobné identifikátory obvykle nazývají \emph{signatura}\cite{Binnie2016}. Pro BitLocker formát je (u~všech verzí) signatura v~ASCII podobě \texttt{-FVE-FS-}\cite{Caseyc2010}.

Pro další práci s~BitLockerem není většina položek hlavičky zajímavá. Výjimku tvoří GUID identifikátor uložený na offsetu 160 (16 bajtů dlouhý UTF-8 textový řetězec) a trojice 32bitových bezznaménkových celočíselných (\texttt{uint32}) hodnot na offsetech 176, 184 a 192, které obsahují umístění (jako relativní offset od začátku zkoumaného zařízení) tří bloků FVE metadat. Všechny tyto čtyři hodnoty jsou v~BitLocker hlavičce umístěny na offsetech, které jsou v~NTFS součástí \emph{bootcode}.

Umístění všech výše zmíněných \uv{důležitých} částí BitLocker hlavičky je zobrazeno na obrázku \ref{fig:bitlocker-header}.

\n{3}{FVE metadata}\label{sec:fve-metadata}

Samotná výše popsaná hlavička formátu BitLocker obsahuje především informace slou\-ží\-cí pro rychlou identifikaci zařízení jako zařízení šifrovaného pomocí technologie BitLocker. Všechny informace potřebné pro práci s~tímto zařízením, tedy především způsob uložení dat, jejich umístění, způsob jakým jsou šifrována a hlavně klíč pro jejich (de)šifrování, jsou uloženy na třech různých místech\footnote{Na offsetech přibližně ve 33 \%, 44 \% a 55 \% u~testovaných BitLocker zařízení.} definovaných v~hlavičce. Jedná se o~tři identické kopie\footnote{Tři kopie jsou zvoleny pravděpodobně jako záloha pro případ náhodného poškození metadat. Vzhledem k~tomu, že bez kompletní nepoškozené kopie těchto metadat není možné data na zařízení dešifrovat, je vícenásobná záloha na místě.} takzvaných \emph{FVE metadat}.

FVE metadata se skládají z~celkem tří částí -- hlavičky FVE bloku (\emph{FVE metadata block header}), samotné FVE hlavičky (\emph{FVE metadata header}) a různého množství FVE záznamů (\emph{FVE metadata entry}, které obsahují samotné klíče a další důležité informace\cite{Metz2011}\footnote{Toto dělení zavádí Joachim Metz v~\cite{Metz2011}. Teoreticky by se daly dvě první části metadat spojit, protože na disku se nachází vždy hned za sebou, ale rozdělení dává smysl, protože první část se týká popisu samotných metadat (signatura, verze, umístění všech tří bloků), zatímco druhá část už obsahuje samotná metadata (GUID, čas vytvoření, použitý šifrovací algoritmus).}.

Důležité položky v~obou hlavičkách, jejich velikosti a offsety (vztažené vůči začátku dané hlavičky) jsou uvedeny v~tabulce \ref{tab:fve-header}. Kompletní struktura obou hlaviček je součástí přílohy \ref{attachment:metadata}.

\tab{Zjednodušená struktura FVE metadat\cite{Metz2011}}{tab:fve-header}{0.65}{|l|l|l|}{
  \hline
   \multicolumn{3}{|c|}{\textbf{Hlavička FVE bloku}} \\ \hline
   offset & velikost & popis  \\ \hline
   0 & 8 & signatura (\texttt{-FVE-FS-}) \\ \hline
   10 & 2 & verze (1 nebo 2) \\ \hline
   32 & 8 & offset první kopie FVE metadat \\ \hline
   40 & 8 & offset druhé kopie FVE metadat \\ \hline
   48 & 8 & offset třetí kopie FVE metadat  \\ \hline
   \multicolumn{3}{}{} \\ \hline
   \multicolumn{3}{|c|}{\textbf{FVE hlavička}} \\ \hline
   0 & 4 & velikost metadat (včetně záznamů) \\ \hline
   16 & 16 & GUID \\ \hline
   36 & 4 & šifrovací algoritmus \\ \hline
   40 & 8 & datum a čas vytvoření \\ \hline
}

Mezi pro nás zajímavé položky v~hlavičce patří její celková velikost (včetně velikosti samotné hlavičky a velikosti za ní následujících záznamů), šifrovací algoritmus použitý pro zašifrování dat uložených na disku (možné algoritmy jsou popsány v~části \ref{sec:algorithms}) a také čas vytvoření, který je uložen ve formátu \texttt{FILETIME}\footnote{FILETIME je ve skutečnosti struktura sestávající ze dvou 32bit celočíselných hodnot, které dohromady udávají počet 100 nanosekundových intervalů, které k~danému datu uplynuly od 1. ledna 1601.\cite{Zxwr6wjYZUQ6z8Yp}}.

\n{3}{FVE záznamy}\label{sec:fve-metadata-entry}

Za výše uvedenou hlavičkou se nachází blíže nespecifikované množství FVE záznamů. Ty slouží v~podstatě jako key-value úložiště pro jakékoli další informace, které jsou pro práci s~BitLockerem potřebné. Tím, že není třeba předem určeno, kolik takových záznamů bude za hlavičkou uloženo, je možné přidávat nové položky při zachování zpětné kompatibility\footnote{Celková největší možná velikost FVE metadat je 64 KiB (alespoň tedy tolik je pro FVE metadata vyhrazeno na vytvořených BitLocker zařízeních), teoreticky je tedy možné mít až 64 KiB - 112 B metadat.}.

Jelikož známe celkovou velikost FVE metadat (je uvedena v~hlavičce, viz tabulka \ref{tab:fve-header}) a celková velikosti hlaviček FVE metadat je pevná (64 a 48 bajtů), pro přečtení všech záznamů stačí číst data ve smyčce, dokud nedojdeme na konec metadat, nebo dokud následující záznam nemá nulovou velikost.

Struktura FVE je relativně jednoduchá a je popsaná v~tabulce \ref{tab:fve-entry}. Důležitou součástí je velikost záznamu, protože podle svého typu může mít různou délku.\cite{Kumar2008,Metz2011}

\tab{Struktura FVE záznamu}{tab:fve-entry}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 2 & velikost záznamu \\ \hline
   2 & 2 & typ záznamu \\ \hline
   4 & 2 & typ hodnoty záznamu \\ \hline
   6 & 2 & verze (1) \\ \hline
   8 &  & data  \\ \hline
}

Typ a hodnota označují, co je v~daném záznamu uloženo. Známé typy a hodnoty jsou popsány v~tabulce \ref{tab:fve-entry-types}. U~typů se typicky jedná buď o~klíč (FVEK, VMK), nebo obecnou \emph{property}, hodnota pak dále specifikuje, jak je daný typ uložen (zašifrovaný klíč, textový řetězec).

Způsob uložení dat záleží na tom, jaká konkrétní data jsou v~záznamu uložena. U~\uv{jednoduchých} záznamů, jako je například popisek, je v~datech uložen textový řetězec uložený v~kódování UTF-16, u~\uv{složitějších} záznamů, jako jsou například klíče, mají data vlastní strukturu včetně dalších záznamů.

\begin{table}[h]
\catcode`\-=12
\captionsetup{width=0.65\linewidth}
\caption{Známé typy FVE záznamů}
\label{tab:fve-entry-types}
\begin{center}
\centering
\begin{tabular}{|l|l|c|l|l|}
  \cline{1-2} \cline{4-5}
   \multicolumn{2}{|c|}{\textbf{Typy}} &  & \multicolumn{2}{|c|}{\textbf{Hodnoty}} \\ \cline{1-2} \cline{4-5}
   typ & popis &  & typ & popis \\ \cline{1-2} \cline{4-5}
   0 & property & & 0 & smazáno \\ \cline{1-2} \cline{4-5}
   1 & VMK & & 1 & klíč \\ \cline{1-2} \cline{4-5}
   2 & FVEK & & 2 & string \\ \cline{1-2} \cline{4-5}
   7 & popisek & & 5 & AES-CCM šifrovaný klíč \\ \cline{1-2} \cline{4-5}
   15 & hlavička disku\footnotemark & & 6 & TPM klíč \\ \cline{1-2} \cline{4-5}
   \multicolumn{2}{c}{} & & 8 & VMK \\ \cline{4-5}
   \multicolumn{2}{c}{} & & 15 & offset a velikost \\ \cline{4-5}
   

\end{tabular}
\end{center}
\end{table}

\footnotetext{Umístění a velikost NTFS hlavičky otevřeného zařízení. Odpovídá hodnotě 15. Podrobnější informace o~umístění NTFS hlavičky na šifrovaném zařízení jsou v~části \ref{sec:data-map}.}

Příklad \uv{jednoduchého} záznamu je uveden na obrázku \ref{fig:fve-entry-desc}, kde vidíme záznam typu \emph{description} (popisek). Ten v~podstatě obsahuje jméno počítače, na kterém bylo dané BitLocker zařízení vytvořeno a také datum vytvoření. Můžeme tedy vidět, že toto konkrétní BitLocker zařízení bylo vytvořeno na počítači \texttt{DESKTOP-NPM7RCA} a to 3. února 2019. Tato informace je uložena jako standardní textový řetězec v~kódování UTF-16. Kromě tohoto řetězce jsou pak na obrázku zvýrazněny i další údaje: velikost celého záznamu (64 bajtů), jeho typ (7 --- popisek) a hodnota (2 --- textový řetězec) a verze (1).


\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
02195070  $\textcolor{red}{40 00}$ $\textcolor{orange}{07 00}$ $\textcolor{yellow}{02 00}$ $\textcolor{green}{01 00}$  $\textcolor{blue}{44 00 45 00 53 00 4b 00}$ |@.......$\textcolor{blue}{D.E.S.K.}$|
02195080  $\textcolor{blue}{54 00 4f 00 50 00 2d 00}$  $\textcolor{blue}{4e 00 50 00 4d 00 37 00}$ |$\textcolor{blue}{T.O.P.-.N.P.M.7.}$|
02195090  $\textcolor{blue}{52 00 43 00 41 00 20 00}$  $\textcolor{blue}{47 00 3a 00 20 00 32 00}$ |$\textcolor{blue}{R.C.A. .G.:. .2.}$|
021950a0  $\textcolor{blue}{2f 00 33 00 2f 00 32 00}$  $\textcolor{blue}{30 00 31 00 39 00}$ 00 00 |$\textcolor{blue}{/.3./.2.0.1.9.}$..|
\end{lstlisting}
		\caption{Příklad FVE záznamu typu \uv{description} (popisek)}
		\label{fig:fve-entry-desc}
\end{figure}

U~jednoduchého zařízení --- v~tomto konkrétním případě USB flash disku --- se bude obvykle vyskytovat pouze pět záznamů a to již výše zmíněný popisek, dvojice záznamů typu VMK, jeden záznam typu FVEK (více informací o~obou se nachází v~části \ref{sec:keys}) a jeden záznam obsahující informace o~umístění hlavičky disku (více informací o~tomto záznamu se nachází v~části \ref{sec:data-map}).

\n{2}{Klíče}\label{sec:keys}

Pravděpodobně nejdůležitější součástí BitLocker hlavičky jsou šifrovací klíče. Ve FVE metadatech nalezneme celkem dva typy klíčů --- Full Volume Encryption Key, neboli FVEK, a Volume Master Key, neboli VMK\footnote{Původní varianta BitLockeru má ještě jeden klíč --- TWEAK, ten je podrobněji popsán v~části \ref{sec:old-versions}.}. Uloženy jsou v~metadatových záznamech odpovídajících typů v~zašifrované podobě.

\n{3}{Full Volume Encryption Key}

Full Volume Encryption Key (dále jen \uv{FVEK}) je nejdůležitějším klíčem pro celý BitLocker. Pomocí tohoto klíče jsou totiž zašifrovaná data uložená na disku. FVEK samotný nejde změnit bez kompletního přešifrování všech dat a v~případě jeho poškození nebo náhodného smazání, není možné uložená data nijak dešifrovat.

FVEK je v~metadatech uložen v~záznamu typu \emph{FVEK} s~hodnotou \emph{AES-CCM šifrovaný klíč} a je, jak hodnota naznačuje, zašifrován pomocí šifry AES-CCM (o~této šifře a módu více v~části \ref{sec:algorithms}), kdy je jako klíč použit VMK.

\tab{Způsob uložení FVEK v~metadatech}{tab:fvek-data}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 8 & datum a čas vytvoření (jako FILETIME) \\ \hline
   8 & 4 & nonce \\ \hline
   12 & 16 & MAC tag \\ \hline
   28 & 44\footnotemark & šifrovaný klíč \\ \hline
}
\footnotetext{Velikost šifrovaného klíče záleží na použité šifře --- 12 bajtů vždy připadne na informace o~klíči a 32 bajtů v~tomto případě připadá na samotný klíč, jelikož je použit 128bit AES.}

Struktura dat pro FVEK v~metadatovém záznamu je popsána v~tabulce \ref{tab:fvek-data}. Kromě samotného klíče obsahují datum a čas jeho vytvoření a nonce.\cite{Metz2011,Kornblum2009} Nonce (z~anglického \uv{\emph{n}umber used \emph{once}}) je unikátní číslo (v~tomto případě prostá posloupnost začínající od nuly a zvyšující se s~každým klíčem) sloužící společně s~datem a časem vytvoření jako inicializační vektor pro dešifrování\cite{Kohnoc2010}.

Samotná zašifrovaná část klíče obsahuje kromě samotného klíče také další data o~klíči samotném --- velikost, verze a šifrovací metoda použitá pro data zašifrovaná pomocí FVEK. Jejich struktura je popsána v~tabulce \ref{tab:fvek-data-decrypted}.\cite{Metz2011,Kornblum2009}

\tab{Obsah FVEK po dešifrování}{tab:fvek-data-decrypted}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 4 & velikost \\ \hline
   4 & 4 & verze (1)\footnotemark \\ \hline
   8 & 4 & šifrovací metoda \\ \hline
   12 & 32 & klíč \\ \hline
}

Na obrázku \ref{fig:fvek-decrypted} je pak vidět příklad dešifrovaného FVEK. Zvýrazněny jsou jeho celková velikost (44 bajtů), verze (1), použitá šifrovací funkce (hexadecimální kód \texttt{0x8004} v~tomto případě znamená 128bit AES-XTS) a následně samotnou dvojici 128bit klíčů pro AES-XTS (o~klíčích pro AES-XTS více v~části \ref{sec:aes-xts}).

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000  $\textcolor{red}{2c 00 00 00}$ $\textcolor{green}{01 00 00 00}$  $\textcolor{orange}{04 80 00 00}$ $\textcolor{blue}{a4 d0 11 64}$ |,..............d|
00000010  $\textcolor{blue}{0c a0 df ec b2 4d a2 39}$  $\textcolor{blue}{b1 4e 4a b7 62 56 f2 e3}$ |.....M.9.NJ.bV..|
00000020  $\textcolor{blue}{b2 27 54 40 91 21 0e 98}$  $\textcolor{blue}{aa 84 5f 52}$             |.'T@.!...._R|
\end{lstlisting}
		\caption{Dešifrovaný FVEK}
		\label{fig:fvek-decrypted}
\end{figure}

\footnotetext{Některé zdroje \cite{Metz2011} uvádějí verzi pouze jako 2 bajtovou a následující 2 bajty jako \uv{neznámé}. Vzhledem k~tomu, že v~jiných hlavičkách je verze v~některých případech 4 bajtová a v~některých 2 bajtová a že na testovacích zařízeních byly tyto dva bajty vždy nulové, domnívám se, že je pravděpodobnější, že verze je zde 4 bajtová.}

\n{3}{Volume Master Key}\label{sec:vmk}

Jak již bylo řečeno výše, FVEK je na disku uložen zašifrován pomocí Volume Master Key (dále jen \uv{VMK}). Ten je uložen také v~metadatových záznamech ve FVE metadatech a je také zašifrován. Na rozdíl od FVEK, který je vždy uložen v~pouze v~jediné kopii, VMK může být ve FVE metadatech uložen vícekrát, pokaždé chráněný jiným způsobem, tedy pokaždé jinak zašifrovaný.

Tento systém umožňuje, aby byl FVEK (jakožto hlavní a nejdůležitější klíč) uložen na disku pouze v~jediné kopii, ale zároveň existovala možnost, jak mít pro jedno zařízení více různých hesel (respektive více různých způsobů odemčení daného zařízení)\cite{Kornblum2009}. Pro přidání nového hesla tak teoreticky stačí znát alespoň jedno již existující heslo\cite{Lich2016}, pomocí kterého se VMK dešifruje a následně uloží zašifrovaný pomocí nového hesla. Analogicky tak lze také snadno změnit heslo --- jak již bylo zmíněno výše, FVEK nejde změnit bez přešifrování celého zařízení, ale změna hesla díky tomuto systému znamená pouhé uložení nově zašifrovaného VMK.

V~odstavci výše je několikrát zmíněno \emph{heslo}, ale VMK může být chráněn více různými způsoby. Dokumentace BitLockeru \cite{Zxwr6wjYZUQ6z8Yo} zmiňuje celkem deset možných typů \emph{protektorů} klíčů (tedy deset způsobů, jak může být daný klíč chráněn, respektive šifrován) v~BitLockeru. Tyto možnosti jsou zapsány v~tabulce \ref{tab:vmk-protectors}.

\tab{Možnosti ochrany VMK}{tab:vmk-protectors}{0.65}{|l|l|}{
  \hline
   hodnota & popis  \\ \hline
   0 & neznámý/jiný \\ \hline
   1 & TPM \\ \hline
   2 & externí klíč \\ \hline
   3 & číselné heslo \\ \hline
   4 & TPM a PIN \\ \hline
   5 & TPM klíč \\ \hline
   6 & TPM, PIN a klíč \\ \hline
   7 & veřejný klíč \\ \hline
   8 & heslo \\ \hline
   9 & TPM certifikát \\ \hline
  10 & CryptoAPI Next Generation (CNG) \\ \hline
}

Z~pohledu této práce je nejobvyklejším protektorem právě heslo, protože použití BitLocker zařízení v~linuxovém prostředí se dá předpokládat primárně u~flash disků, u~nichž se používá ochrana heslem\footnote{Ochrana pomocí TPM nedává u~přenosných disků smysl, protože TPM čipy jsou nedělitelnou součástí hardwaru a takto chráněný disk by nešlo na jiném počítači dešifrovat.}.

Pro každé vytvořené BitLocker se kromě primární ochrany (v~našem případě typicky hesla) vytváří ještě jeden VMK chráněný takzvaným záložním heslem. Způsob ochrany je u~něj stejný jako u~VMK, který je chráněný heslem, rozdíl je v~tom, že heslo zadává uživatel, kdežto záložní heslo je vygenerované a uživateli je při vytváření \uv{předáno} v~podobě souboru, který obsahuje 48 čísel. U~něj se předpokládá, že si jej uživatel buď vytiskne, nebo bezpečně uloží v~elektronické podobě. U~strojů přihlášených v~síti Active Directory lze také záložní klíče automaticky zálohovat na doménovém serveru. Pomocí záložního hesla lze pak zařízení odemknout stejně, jako při použití normálního hesla a pomocí nástrojů obsažených v~základní instalaci Windows nastavit nové heslo (nebo nastavit nové TPM, či jiný způsob ochrany).\cite{Hall2019,MS2011}

Struktura VMK, naznačená v~tabulce \ref{tab:vmk-data}, je ovlivněna tím, že samotný klíč může být chráněn různými způsoby a je pro něj tedy třeba ukládat různá metadata, a i samotný klíč může být potřeba v~některých případech ukládat v~různých podobách.

První část VMK struktury je v~celku běžná --- obsahuje identifikátor klíče (GUID), čas vytvoření a typ ochrany. Další metadata jsou pak uložena jako záznamy, stejně jako u~samotné FVE hlavičky (podrobněji v~části \ref{sec:fve-metadata-entry} a tabulce \ref{tab:fve-entry}).

\tab{Struktura VMK}{tab:vmk-data}{0.65}{|l|l|l|}{
  \hline
   offset & velikost & popis  \\ \hline
   0 & 16 & GUID \\ \hline
   16 & 9 & datum a čas vytvoření \\ \hline
   24 & 2 & neznámé \\ \hline
   26 & 2 & typ ochrany \\ \hline
   28 &  & metadatové záznamy \\ \hline
}

Kompletní VMK klíč chráněný záložním heslem je zobrazen na obrázku \ref{fig:vmk-bpwprotected}. Zvý\-raz\-ně\-no je GUID, typ ochrany (8 --- heslo) a dva připojené záznamy, oba typu property, první obsahující sůl potřebnou pro odvození klíče potřebného pro dešifrování VMK ze záložního hesla (funkcionalita odvození klíče z~hesla je popsána v~části \ref{sec:kdf}) a druhá obsahující samotný klíč (textový výpis je debugovacím výstupem z~nástroje vytvořeného v~rámci praktické části).

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000 $\textcolor{blue}{c1 56 2e 01 d6 4e 27 45}$  $\textcolor{blue}{8a bf 7a 9f 29 e0 b5 21}$  |.V...N'E..z.)..!|
00000010 40 c5 cd 54 a0 bb d4 01  00 00 $\textcolor{red}{00 08}$ ac 00 00 00  |@..T............|
00000020 03 00 01 00 00 10 00 00  $\textcolor{green}{46 ee b7 10 0e 43 4d d4}$  |........F....CM.|
00000030 $\textcolor{green}{f1 84}$ a5 ab eb c6 21 f4  40 00 12 00 05 00 01 00  |....!...@.......|
00000040 40 7d e5 52 a0 bb d4 01  04 00 00 00 72 b0 71 f4  |@}.R........r.q.|
00000050 20 9e c9 8e b7 1b 5e 42  71 b5 bc 21 c6 57 9b 29  | .....^Bq..!.W.)|
00000060 56 2c 92 ad db d7 73 75  a9 78 c2 94 c5 a5 07 d1  |V,....su.x......|
00000070 62 61 0c 56 d8 ca 9d ac  50 00 13 00 05 00 01 00  |ba.V....P.......|
00000080 40 7d e5 52 a0 bb d4 01  05 00 00 00 3e d9 ac 58  |@}.R........>..X|
00000090 e6 86 ba ac 05 48 ea 0b  64 ee 77 7a b4 77 ba cb  |.....H..d.wz.w..|
000000a0 c0 83 83 b0 7b ab 52 c7  0d 9e 8f 62 d7 cb a3 90  |....{.R....b....|
000000b0 cc b8 8e 39 a4 be 8a 0a  5c 16 86 62 c9 64 81 4d  |...9....\..b.d.M|
000000c0 91 9d 27 24 3a 8e a3 7c  50 00 00 00 05 00 01 00  |..'.:..|P.......|
000000d0 40 7d e5 52 a0 bb d4 01  06 00 00 00 97 18 2f d6  |@}.R........../.|
000000e0 83 de e7 63 0a fa 57 48  44 2b 66 90 $\textcolor{orange}{91 a0 ad e9}$  |...c..WHD+f.....|
000000f0 $\textcolor{orange}{0c 08 e8 1e 3d 2f 7d 3b}$  $\textcolor{orange}{cc 9f ba e4 ed b5 6b c2}$  |....=/};......k.|
00000100 $\textcolor{orange}{e1 a4 53 cf c5 60 2a 92}$  $\textcolor{orange}{2d c8 1d 85 10 b7 99 87}$  |..S..`*.-.......|
00000110 $\textcolor{orange}{9d 1d 1e 36 46 40 6b e7}$                           |...6F@k.        |

VMK
	Identifier:	$\textcolor{blue}{012e56c1-4ed6-4527-8abf-7a9f29e0b521}$
	Type:		$\textcolor{red}{VMK protected with recovery password}$
	Salt:		$\textcolor{green}{46 ee b7 10 0e 43 4d d4 a5 ab eb c6 21 f4 f1 84}$
	AES-CCM encrypted key
		Nonce data:	2019-02-03 09:10:36.052000
		Nonce counter:	6
		Key:	 $\textcolor{orange}{91 a0 ad e9 0c 08 ... 1d 1e 36 46 40 6b e7}$
\end{lstlisting}
		\caption{VMK chráněný záložním heslem}
		\label{fig:vmk-bpwprotected}
\end{figure}


\n{2}{Šifrovaná data}

\n{3}{Způsob uložení dat}\label{sec:data-map}

Po hlavičkách a metadatech zbývá popsat jen způsob, jakým jsou na disku uložena samotná šifrovaná data. Protože BitLocker metadata se vyskytují celkem ve třech kopiích na různých místech \uv{uprostřed} šifrovaného zařízení, jsou uložená data rozdělena celkem na čtyři části. Až na jednu výjimku jsou šifrovaná data uložena na správných místech --- tedy na místě, kde mají být uložena i po dešifrování.

Výjimkou je v~tomto případě hlavička souborového systému NTFS. Její umístění je způsobeno poněkud zvláštním rozhodnutím tvůrců BitLockeru, že otevřené zařízení bude mít stejnou velikost, jako zařízení zašifrované, a to i přesto, že si z~jeho celkové velikosti BitLocker metadata uberou přibližně 200 KiB\footnote{U linuxové implementace šifrování disku, technologie LUKS/dm-crypt, byl zvolen jiný přístup --- otevřené zařízení je menší a metadata se na něm nijak neřeší --- jsou z~výsledného zařízení \uv{odstraněna}. První sektor otevřeného zařízení pak obsahuje standardní hlavičku souborového systému bez potřeby dalšího \uv{přesouvání} jako u~BitLockeru.}.

\obr{Schéma \uv{mapování} mezi šifrovaným a otevřeným BitLocker zařízením}{fig:bitlocker-decrypt}{0.75}{img/bitlocker-decrypt-schema.png}

Speciální zacházení vyžaduje NTFS hlavička proto, že na výsledném otevřeném zařízení musí být na jeho začátku, aby toto zařízení bylo systémem správně rozpoznáno jako NTFS a jako takové připojeno. Proto je třeba NTFS hlavičku přesunout na začátek disku a nahradit jí původní BitLocker hlavičku. Umístění NTFS hlavičky v~šifrovaných datech je zapsáno ve FVE metadatech ve speciálním záznamu typu \emph{hlavička disku} (viz tabulka \ref{tab:fve-entry-types}). V~záznamu je uveden offset (v~sektorech, relativně k~začátku disku), na kterém se zašifrovaná NTFS hlavička nachází a její velikost (u~testovaných zařízení 8~KiB, což také odpovídá velikosti vyhrazené pro BitLocker hlavičku).

Vzhledem k~tomu, že výsledné otevřené zařízení má mít stejnou velikost jako šifrované zařízení, zbývá ještě vyřešit, jak bude v~otevřeném zařízení naloženo s~metadaty --- na jejich místě v~otevřeném NTFS musí \uv{něco} být a zároveň je třeba ochránit je proti náhodnému přepsání nebo smazání. Teoreticky je možné tato metadata prostě dešifrovat stejně jako ostatní šifrovaná data. Výsledkem by pak sice byla nesmyslná data, ale pokud je zařízení již otevřeno, není třeba k~metadatům již znovu přistupovat a je tedy jedno, že nejsou \uv{čitelná}. Takováto \uv{nesmyslná} data by už jen stačilo v~rámci NTFS ochránit před přepsáním. Pokud by bylo třeba k~metadatům přistupovat i u~otevřeného zařízení, bylo by další možností nechat je prostě viditelná tak, jak jsou (a opět je ochránit před přepsání).

Autoři BitLockeru ale nakonec sáhli po třetí možnosti --- metadata jsou v~otevřeném zařízení nahrazena nulami. Ve výsledném otevřeném NTFS tak jsou metadata viditelná jako speciální systémové soubory uložené ve složce \texttt{System Volume Information}. Sou\-bo\-ry jsou samozřejmě prázdné, respektive plné nul, ale zabraňují přepsání míst, na kterých se skutečná metadata vyskytují. Ve Windows je tato složka ve výchozím nastavení skryta.

\n{3}{Postup při dešifrování}

Při znalosti struktury metadat a způsobu uložení šifrovaných dat, je další postup dešifrování následující: z~FVE hlavičky (tabulka \ref{tab:fve-header}) zjistíme, jaký byl použit šifrovací algoritmus (v~nejnovějších verzích BitLockeru to bude AES-XTS), pomocí uživatelem zadaného hesla dešifrujeme VMK s~odpovídajícícm typem ochrany (tabulka \ref{tab:vmk-protectors}) a pomocí něj dešifrujeme FVEK, kterým jsou zašifrována samotná data.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
00000000  eb 52 90 4e 54 46 53 20  20 20 20 00 02 08 00 00  |.R.NTFS    .....|
00000010  00 00 00 00 00 f8 00 00  3f 00 ff 00 00 28 03 00  |........?....(..|
00000020  00 00 00 00 80 00 00 00  ff 1f 03 00 00 00 00 00  |................|
00000030  55 21 00 00 00 00 00 00  02 00 00 00 00 00 00 00  |U!..............|
00000040  f6 00 00 00 01 00 00 00  52 53 3d 84 7d 3d 84 a4  |........RS=.}=..|
00000050  00 00 00 00 fa 33 c0 8e  d0 bc 00 7c fb 68 c0 07  |.....3.....|.h..|
00000060  1f 1e 68 66 00 cb 88 16  0e 00 66 81 3e 03 00 4e  |..hf......f.>..N|
00000070  54 46 53 75 15 b4 41 bb  aa 55 cd 13 72 0c 81 fb  |TFSu..A..U..r...|
00000080  55 aa 75 06 f7 c1 01 00  75 03 e9 dd 00 1e 83 ec  |U.u.....u.......|
00000090  18 68 1a 00 b4 48 8a 16  0e 00 8b f4 16 1f cd 13  |.h...H..........|
000000a0  9f 83 c4 18 9e 58 1f 72  e1 3b 06 0b 00 75 db a3  |.....X.r.;...u..|
000000b0  0f 00 c1 2e 0f 00 04 1e  5a 33 db b9 00 20 2b c8  |........Z3... +.|
000000c0  66 ff 06 11 00 03 16 0f  00 8e c2 ff 06 16 00 e8  |f...............|
000000d0  4b 00 2b c8 77 ef b8 00  bb cd 1a 66 23 c0 75 2d  |K.+.w......f#.u-|
000000e0  66 81 fb 54 43 50 41 75  24 81 f9 02 01 72 1e 16  |f..TCPAu$....r..|
000000f0  68 07 bb 16 68 52 11 16  68 09 00 66 53 66 53 66  |h...hR..h..fSfSf|
00000100  55 16 16 16 68 b8 01 66  61 0e 07 cd 1a 33 c0 bf  |U...h..fa....3..|
00000110  0a 13 b9 f6 0c fc f3 aa  e9 fe 01 90 90 66 60 1e  |.............f`.|
...
00000150  0f 82 16 00 66 ff 06 11  00 03 16 0f 00 8e c2 ff  |....f...........|
00000160  0e 16 00 75 bc 07 1f 66  61 c3 a1 f6 01 e8 09 00  |...u...fa.......|
00000170  a1 fa 01 e8 03 00 f4 eb  fd 8b f0 ac 3c 00 74 09  |............<.t.|
00000180  b4 0e bb 07 00 cd 10 eb  f2 c3 0d 0a 41 20 64 69  |............A di|
00000190  73 6b 20 72 65 61 64 20  65 72 72 6f 72 20 6f 63  |sk read error oc|
000001a0  63 75 72 72 65 64 00 0d  0a 42 4f 4f 54 4d 47 52  |curred...BOOTMGR|
000001b0  20 69 73 20 63 6f 6d 70  72 65 73 73 65 64 00 0d  | is compressed..|
000001c0  0a 50 72 65 73 73 20 43  74 72 6c 2b 41 6c 74 2b  |.Press Ctrl+Alt+|
000001d0  44 65 6c 20 74 6f 20 72  65 73 74 61 72 74 0d 0a  |Del to restart..|
000001e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001f0  00 00 00 00 00 00 8a 01  a7 01 bf 01 00 00 55 aa  |..............U.|
00000200
\end{lstlisting}
		\caption{První sektor dešifrovaného BitLocker zařízení (NTFS hlavička)}
		\label{fig:ntfs-header}
\end{figure}

Jedinou neznámou potřebnou pro dešifrování dat tak zůstává inicializační vektor. Ten u~nejnovější verze BitLockeru odpovídá offsetu (v~sektorech), na kterém jsou daná šifrovaná data uložena na zašifrovaném zařízení (první sektor NTFS hlavičky, který bude v~dešifrovaných datech uložen na začátku tak má inicializační vektor daný svou pozicí v~šifrovaných datech, nikoli nulový, jak by se mohlo zdát). O~způsobu použití inicializačního vektoru v~BitLockeru podrobněji pojednává část \ref{sec:iv}.

Dešifrovaný první sektor je vidět na obrázku \ref{fig:ntfs-header}. Jde zde velmi dobře poznat podobnost NTFS hlavičky s~BitLocker hlavičkou (obrázek \ref{fig:bitlocker-header}). Hlavní odlišností je signatura, která je zde jasně viditelná jako \texttt{NTFS}, na rozdíl od \texttt{-FVE-FS-} u~BitLockeru. Chybí také offsety BitLocker metadat, které u~BitLocker hlavičky \uv{zabírají} část boot kódu, který je u~NTFS kompletní. Zajímavá je stejná boot signatura (\texttt{55 aa}) u~obou hlaviček.

U~zbývajících dat pak dešifrování probíhá stejně --- po 512 B sektorech s~inicializačním vektorem nastaveným na číslo sektoru odpovídající jejich umístění na šifrovaném zařízení. Jedinou výjimkou jsou oblasti BitLocker metadata, která jsou nahrazena nulami, jak bylo popsáno v~části \ref{sec:data-map}.

\n{2}{Odlišnosti ve starších verzích}\label{sec:old-versions}

Výše popsaná struktura diskového formátu BitLocker, způsob uložení klíčů a rozložení dat na šifrovaném a dešifrovaném zařízení, odpovídají aktuální nejnovější verzi BitLockeru dostupné ve Windows 7 a novějších. Původní verze dostupná ve Windows Vista se v~některých drobnostech mírně liší. Tato práce se primárně zaobírá nejnovější verzí, protože je v~současné době jedinou podporovanou (oficiální podpora Windows Vista byla ukončena 11. dubna 2017\cite{hfTs55csrXKY7b4F}). Podpora pro starší verze však může být také v~některých případech vyžadovaná, a proto si ve stručnosti představíme nejvýznamnější odlišnosti mezi těmito verzemi.

Nejvýraznější změnou je nejspíše změna algoritmu použitého pro šifrování data z~AES-CBC s~Elephant difuzérem nejdříve pouze na AES-CBC\cite{Rosendorf2013} a později na AES-XTS\cite{Sosnowski2016} (rozdíl mezi těmito algoritmy je popsán v~části \ref{sec:algorithms}), ale menší změny se týkají i samotných metadat a hlavičky.

\n{3}{Hlavička}

Samotná BitLocker hlavička se změnila jen minimálně. Zajímavé je, že starší verze obsahuje offset pouze pouze první kopie FVE metadat a to přesto, že i tato verze obsahuje tři kopie. Offsety ostatních kopií je tak třeba vyčíst ze samotných metadat. Díky tomu se všechna metadata specifická pro BitLocker \uv{vešla} do nevyužitých oblastí v~NTFS hlavičce (od které je BitLocker hlavička odvozen, viz \ref{sec:header}) a nezasahují tak do boot kódu. Na druhou stranu v~případě poškození první kopie FVE metadat bude složitější najít na disku další dvě záložní kopie.

\n{3}{FVE metadata}

FVE metadata se u~starší verze liší pouze v~drobných detailech. Výhodou FVE metadat je, že jsou verzovaná a lze tak snadno rozpoznat, o~jakou variantu BitLockeru se jedná. Starší varianta má verzi 1, novější varianta má verzi 2. Důležité hodnoty (signatura, velikost, umístěné offsetů všech tří kopií FVE metadat) jsou v~obou verzích stejné.

\n{3}{Klíče}

Struktura klíčů VMK a FVEK se u~starší verze BitLockeru nijak neliší. Jediný rozdíl představuje další klíč TWEAK, který se používá pro šifrování inicializačního vektoru. TWEAK klíč je uložen, podobně jako FVEK, zašifrovaný pomocí VMK ve FVE metadatech jako speciální záznam (viz \ref{sec:fve-metadata-entry}).

\n{3}{Šifrovaná data}

Asi největší odlišnost u~starších verzí je ve způsobu uložení šifrovaných dat a to především v~umístění NTFS hlavičky otevřeného zařízení. Zatímco u~novější verze BitLockeru je tato hlavička zašifrovaná a uložená na speciálním místě zapsaném ve FVE metadatech (způsob umístění šifrované NTFS hlavičky je popsán v~části \ref{sec:data-map}), v~původní variantě BitLockeru je NTFS hlavička uložena nezašifrovaná a to přímo na svém \uv{původním} místě na začátku disku. Vzhledem k~malé odlišnosti původní hla\-vič\-ky BitLockeru a hlavičky NTFS stačí při dešifrování nahradit určité části BitLocker hlavičky a výsledkem je validní NTFS hlavička pro dešifrované zařízení. 

Nahradit je třeba signaturu --- místo původního \texttt{-FVE-FS-} dosadíme \texttt{NTFS} (standardní signatura souborového systému NTFS) a offset první kopie FVE metadat --- ten nahradí adresa prvního clusteru MFT, která je uložen ve FVE metadatech.\cite{Metz2011}

Poslední rozdíl v~šifrovaných datech spočívá v~inicializačním vektoru použitém pro jejich (de)šifrování. Stejně jako u~novější verze BitLockeru se zde použije číslo sektoru, ale nikoli prosté, ale zašifrované pomocí TWEAK klíče.

\n{1}{Existující řešení pro práci s~BitLockerem v~Linuxu}

Pro Linux již v~současné době existují nástroje, které umí s~BitLockerem více či méně pracovat. Podle aktivity vývoje a pokrytí funkcionality BitLockeru jsou nejvýznamnější dva projekty --- knihovna libbde\cite{Metz2018} a nástroj Dislocker\cite{Coltel2017}.

\n{2}{Knihovna libbde}

Knihovna libbde vytvořená Joachimem Metzem představuje asi nejlepší software pro práci s~BitLockerem v~linuxových systémech a nejen tam, protože podporuje i systémy Microsoft Windows a MacOS X\cite{Metz2016}. Kromě knihovny jsou součástí projektu i nástroje pro koncové uživatele \texttt{bdemount} a \texttt{bdeinfo}. Ukázka výstupu nástroje \texttt{bdeinfo}, který slouží primárně pro analýzu existujících zařízení, je vidět na obrázku \ref{fig:libbde-bdeinfo}. Užitečná může být také dostupnost rozhraní pro jazyk Python (samotná knihovna je implementována v~jazyce C).

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
BitLocker Drive Encryption information:
	Encryption method		: AES-XTS 128-bit
	Volume identifier		: 1f8bf933-8323-4c97-8a89-a67625ac8f40
	Creation time			: Feb 03, 2019 09:10:22.265405900 UTC
	Description			: DESKTOP-NPM7RCA G: 2/3/2019
	Number of key protectors	: 2

Key protector 0:
	Identifier			: f0f61678-fb6f-4ab1-934a-7094f5b68a85
	Type				: Password

Key protector 1:
	Identifier			: 012e56c1-4ed6-4527-8abf-7a9f29e0b521
	Type				: Recovery password
\end{lstlisting}
		\caption{Ukázka výstupu nástroje \texttt{bdeinfo}}
		\label{fig:libbde-bdeinfo}
\end{figure}

Podpora BitLockeru, kterou tato knihovna poskytuje, je velice rozsáhlá a libbde dokáže pracovat se všemi jeho existujícími formáty a verzemi. Dokumentace pro tuto knihovnu také obsahuje obsáhlý popis BitLockeru, formátu hlaviček a metadat\cite{Metz2011}, který byl neocenitelný při přípravě této diplomové práce.

Bohužel i přes tyto rozsáhlé možnosti má knihovna libbde několik vlastností, které z~ní dělají nevhodného kandidáta na nástroj pro každodenní použití. Předně je zde problém s~neexistující podporou pro zápis --- otevřené zařízení je připojitelné pouze pro čtení a ačkoli je podpora pro zápis plánována již od roku 2014\footnote{libbde Issue \#1: Add write support --- https://github.com/libyal/libbde/issues/1}, stále není k~dispozici. Kvůli tomu se může jednat o~nástroj vhodný pro forenzní analýzu nebo záchranu dat, ale například pro vytvoření šifrovaného flash disku, který bude sloužit ke sdílení dat mezi Windows a Linuxem, je toto řešení nepoužitelné.

Z~hlediska případného dalšího vývoje nebo použití v~jiných projektech, je také mi\-ni\-mál\-ně diskutabilní použití některých technologií. Knihovna libbde je součástí většího projektu \emph{libyal}\footnote{Overview of the libyal projects --- https://github.com/libyal/libyal/wiki/Overview}, který obsahuje několik desítek různých knihoven. Jednou z~nich je i knihovna \emph{libaes}, která poskytuje multiplatformní implementaci AES a kterou libbde používá pro dešifrování dat. Používání \uv{vlastních} implementací šifrování je obecně nedoporučováno a preferuje se použití standardních knihoven jako například \emph{libopenssl} nebo \emph{libgcrypt}, které mají teoreticky zaručit správnost implementace kryptografických algoritmů. Použitá knihovna libaes například při dešifrování klíčů kvůli špatné implementaci AES-CCM vůbec nekontroluje přiložený MAC tag\footnote{libaes Issue \#2: AES CCM implementation seems to different / non-compliant than others --- https://github.com/libyal/libcaes/issues/2}.

Pro potenciální uživatele může být problematická také implementace v~\emph{user space} pomocí FUSE\footnote{FUSE je interface pro práci se souborovými systémy v~user space, bez potřeby programovat přímo v~kernel space, a je tedy dostupný i pro neprivilegované uživatele\cite{Singh2014}.}, které sice výrazně zjednodušuje vývoj, ale může mít velmi výrazný vliv na výkon --- zpomalení oproti implementaci v~kernelu může nastat až o~83 \% a zatížení CPU může narůstat až o~31 \%\cite{Vangoor2017}.

Nevýhodou FUSE je také, že vytvořené otevřené \uv{zařízení} ve skutečnosti není systémový nástroji rozpoznané jako blokové zařízení a to právě proto, že bylo vytvořeno v~user space. Takto vytvořené zařízení sice lze připojit pomocí příkazu \texttt{mount}, kdy je na něm úspěšně rozpoznám souborový systém NTFS a jako takový je úspěšně připojen, ale protože jej systém nerozpozná jako nově přidané blokové zařízení, není možné jej detekovat a připojit automaticky.

Pro případnou integraci do existujících nástrojů pro práci s~úložnými zařízeními, může být teoreticky problém také licence --- libbde je dostupná pod licencí GNU LGPL verze 3, která je zpětně nekompatibilní s~verzí 2 a použití takové knihovny by (i u~nástrojů a knihoven a dostupných pod licencí GNU LGPL verze 2 a novější) automaticky změnilo licenci výsledného programu na GNU LGPL verze pouze 3\cite{GNU2019}.

Obecně lze říci, že knihovna libbde a s~ní dostupné uživatelské nástroje jsou velmi užitečné pro případnou záchranu dat ze zařízení zašifrovaného pomocí BitLockeru, při nemožnosti použít Windows, případně pro různou analýzu dat, ale bohužel nevhodné pro každodenní použití. Volba použitých technologií (FUSE, vlastní implementace kryptografických funkcí) z~libbde také dělá nevhodného kandidáta na další rozšíření a případné začlenění do existujících aplikací a nástrojů.

\n{2}{Dislocker}

Druhým projektem, který se zabývá podporou BitLockeru v~linuxových systémech, je nástroj Dislocker. Velkou výhodou tohoto nástroje je, že (na rozdíl od knihovny libbde) podporuje i zápis na otevřené BitLocker zařízení. Kromě Linuxu podporuje také MacOS X a BSD systémy. Součástí Dislockeru jsou kromě samotného nástroje \texttt{dislocker} i nástroj pro analýzu metadat \texttt{dislocker-metadata} (ukázka z~jeho výstupu je na obrázku \ref{fig:dislocker-metadata}, nástroj \texttt{dislocker-file} sloužící pro dešifrování celého zařízení a uložení dat do souboru a také nástroj \texttt{dislocker-find} pro nalezení blokových zařízení s~BitLocker formátem.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
 =====================[ BitLocker information structure ]=====================
   Signature: '-FVE-FS-'
   Total Size: 0x0370 (880) bytes (including signature and data)
   Version: 2
   Current state: ENCRYPTED (4)
   Next state: ENCRYPTED (4)
   Encrypted volume size: 104857600 bytes (0x6400000), ~100 MB
   Size of convertion region: 0 (0)
   Number of boot sectors backuped: 16 sectors (0x10)
   First metadata header offset:  0x2195000
   Second metadata header offset: 0x2c1d000
   Third metadata header offset:  0x373a000
   Boot sectors backup address:   0x21a5000
   ----------------------------{ Dataset header }----------------------------
     Dataset size: 0x00000324 (804) bytes (including data)
     Unknown data: 0x00000001 (always 0x00000001)
     Dataset header size: 0x00000030 (always 0x00000030)
     Dataset copy size: 0x00000324 (804) bytes
     Dataset GUID: '1F8BF933-8323-4C97-8A89-A67625AC8F40'
     Next counter: 10
     Encryption Type: AES-XTS-128 (0x8004)
     Epoch Timestamp: 1549185022 sec, that to say Sun Feb  3 09:10:22 2019
   --------------------------------------------------------------------------

\end{lstlisting}
		\caption{Ukázka výstupu nástroje \texttt{dislocker-metadata}}
		\label{fig:dislocker-metadata}
\end{figure}

Nevýhody Dislockeru jsou pak podobné jako u~výše zmíněné knihovny libbde --- implementace využívá FUSE a součástí nástroje je také vlastní implementace AES. Jedná se také pouze o~nástroj pro koncové uživatele, nikoli o~knihovnu a případná integrace se systémovými nástroji by tak byla složitější. Hlavní nevýhodou je však (pravděpodobně) ukončený vývoj tohoto nástroje --- poslední commit v~Git repozitáři je z~roku 2017.

Obecně je nástroj Dislocker pro koncové uživatele vhodnější, než knihovna libbde a s~ní spojené nástroje a to především proto, že umožňuje na BitLocker zařízení také zapisovat. Sdílí ovšem stejné problémy, které z~něj nedělají ideální řešení pro další použití či případné rozšíření nebo začlenění do existujících aplikací a nástrojů.


% ============================================================================ %
\cast{Projektová část}

\n{1}{BitLocker zařízení v~linuxovém prostředí}

Hlavním cílem této práce je navrhnout a případně implementovat řešení pro práci s~BitLocker zařízeními v~linuxovém prostředí, které bude jednoduché na použití pro běžné uživatele a které vyřeší problémy stávajících řešení, jako je používání nestandardních kryptografických knihoven nebo používání technologie FUSE, která má negativní dopad jak na výkon, tak na uživatelskou přívětivost.

Splnění výše uvedených požadavků lze rozdělit do tří částí:

\begin{enumerate}
	\item podpora pro přímou práci se šifrovanými daty, tedy jejich dešifrování při čtení a šifrování při zápisu,
	\item podpora pro práci s~metadaty BitLockeru, tedy identifikaci BitLocker zařízení a získání důležitých informací pro práci s~BitLockerem, jako je použitý šifrovací algoritmus, způsob uložení dat na disku a především klíče pro (de)šifrování dat a
	\item integrace s~existujícími systémový nástroji a démony pro práci s~úložnými zařízeními tak, aby z~pohledu uživatele fungovala práce s~BitLocker zařízeními stejně, jako práce se zařízeními šifrovanými pomocí nativní technologie LUKS/dm-crypt.
\end{enumerate}

První část lze vyřešit pomocí existujícího kernelového ovladače Device Mapper. Přímá nízkoúrovňová práce s~blokovými zařízeními tak bude vyřešena přímo v~kernelu a pro (de)šifrování dat bude využito kryptografických funkcí z~kernel crypto API. Pro podporu nejnovější verze BitLockeru s~šifrováním AES-XTS dokonce není potřeba Device Mapper nijak upravovat. Podrobněji je toto řešení probráno v~části \ref{sec:device-mapper}.

Pro druhou část byl v~rámci této práce implementován nový nástroj, který z~BitLocker hlavičky a FVE metadat zjistí strukturu daného zařízení a se znalostí hesla získá FVEK a připraví správnou konfiguraci pro Device Mapper pro vytvoření otevřeného zařízení. Tento nový nástroj je podrobněji popsán v~části \ref{sec:implementace-nastroj}.

Aby byla zajištěna podpora BitLockeru v~grafických rozhraních, je třeba integrovat vytvořený nástroj do existujících nástrojů pro práci s~úložnými zařízeními, především do démona UDisks, který zajistí, že BitLocker zařízení bude rozpoznáno jako podporované šifrované zařízení a uživateli nabídnuto jeho odemčení. Změny potřebné v~těchto nástrojích jsou popsány v~části \ref{sec:integrace}.

\n{1}{Device Mapper}\label{sec:device-mapper}

Device Mapper je kernelový ovladač, který poskytuje rozhraní pro vytváření nových blokových zařízení pomocí jejich mapování na zařízení existující. Umožňuje tak například vytvořit z~jednoho disku několik menších blokových zařízení, nebo naopak spojit více disků do jednoho zařízení.\cite{RedHat2019}

Device mapper umožňuje vytváření různých zařízení s~různými vlastnostmi, díky různým modulům, takzvaným \emph{targetům}. Ty poskytují jak funkcionalitu pro prosté mapování mezi dvěma či více zařízeními v~podobě targetu \emph{dm-linear}, ale existují i složitější targety, které poskytují i další funkcionalitu nad rámec tohoto mapování, jako například target \emph{dm-raid}, který přidává logiku RAID zařízení.

Z~pohledu této práce jsou však důležité dva targety --- \emph{dm-zero} a především \emph{dm-crypt}.

\n{2}{dm-zero}

První v~této práci použitým targetem je dm-zero. V~podstatě se jedná o~blokové zařízení, které se chová jako \texttt{/dev/zero} --- při čtení vrací nuly a jakékoli zápisy prostě zahazuje bez chyb.\cite{KernelZero}

\n{2}{dm-crypt}

Pro tuto práci nejdůležitějším targetem je dm-crypt, který slouží pro tvorbu šifrovaných zařízení. Kromě samotného mapování mezi existujícím zařízením a zařízením nově vytvořeným, navíc všechny zápisy na mapované zařízení a čtení z~něj (de)šifruje.\cite{Broz2018}

Z~pohledu nástrojů pracujících s~mapovaným zařízením, se tak jedná o~normální nešifrované zařízení --- při čtení bloku jej Device Mapper podle své tabulky napřed přečte ze zašifrovaného disku a dešifruje, takže uživatel dostane již otevřený text. V~případě zápisu je pak situace opačná --- uživatel zapisuje otevřená data, která Device Mapper nejprve zašifruje a teprve poté skutečně zapíše na disk. Zjednodušené schéma fungování crypt targetu je na obrázku \ref{fig:dm-crypt}.

\obr{Fungování dm-crypt targetu z~pohledu user space a kernel space.\cite{Fruhwirth2005}}{fig:dm-crypt}{0.75}{img/dm-crypt.png}

Crypt target se používá primárně pro šifrování disku v~linuxových systémech společně s~technologií LUKS. LUKS se stará o~správu klíčů a definuje také diskový formát pro ukládání metadat. Podobně jako u~BitLockeru je i u~LUKSu klíč pro (de)šifrování dat uložen přímo na disku v~metadatech chráněný heslem, případně dalšími způsoby. Crypt target má tedy v~tomto případě na starosti ukládání dat a jejich dešifrování při čtení a šifrování při zápisu a LUKS slouží pro zjednodušení práce se šifrovaným zařízením, aby si uživatel nemusel pamatovat klíč a další informace nutné pro správné nastavení šifrování.\cite{Fruhwirth2005}

Jak může vypadat Device Mapper tabulka jednoduchého šifrovaného zařízení vy\-tvo\-ře\-né\-ho pomocí technologie LUKS/dm-crypt je vidět v~tabulce \ref{tab:dm-crypt-luks}. Velikosti v~tabulce jsou uváděny v~512 B sektorech.

\tab{Mapa dm-crypt zařízení v~Linuxu}{tab:dm-crypt-luks}{0.65}{|l|l|l|l|l|l|l|l|l|}{
  \hline
   \textbf{jméno} & \textbf{start} & \textbf{velikost} & \textbf{target} & \textbf{šifra} & \textbf{klíč} & \textbf{IV offset} & \textbf{offset}  \\ \hline
   luks & 0 & 172032 & crypt & aes-xts-plain64 & f5..d0 & 0 & 32768 \\ \hline
}

Zde se jedná o~jednoduché šifrované zařízení, které zabírá celé zařízení zašifrované pomocí šifry AES-XTS, kdy inicializačním vektorem je číslo sektoru. Výsledné mapované zařízení je o~16 MiB, které zabírá LUKS hlavička, menší (to udává poslední položka \emph{offset} uváděná v~sektorech).

Crypto target podporuje všechny šifry, které jsou podporovány v~linuxovém kernel crypto API a širokou škálu definic inicializačního vektoru a teoreticky tak umožňuje podporovat různé technologie šifrování disku --- linuxová implementace technologie TrueCrypt/VeraCrypt je také postavena nad Device Mapperem a crypto targetem\cite{Broz2014}.

\n{2}{Device Mapper a BitLocker}

Z~výše uvedeného popisu device mapperu, crypto targetu a stručného představení technologie LUKS, vyplývá, že BitLocker a LUKS/dm-crypt jsou velice podobné technologie. Obě mají na disku metadata v~otevřené podobě, která obsahují zašifrovaný klíč použitý k~šifrování dat uložených na disku. Ve výchozím nastavení dokonce BitLocker i LUKS/dm-crypt používají stejnou šifrovací funkci --- AES-XTS a stejný inicializační vektor --- číslo sektoru. Jsou zde rozdíly ve způsobu uložení dat a metadat na disku a práci s~klíči, ale z~pohledu Device Mapperu stačí znát (de)šifrovací klíč pro data a mapu šifrovaných dat na disku a může s~BitLockerem pracovat stejně jako s~jakýmikoli jinými šifrovanými daty.

Způsob, jak jsou v~BitLocker metadatech uloženy klíče je popsán v~části \ref{sec:keys}. Pro použití s~Device Mapperem tedy stačí pouze získat z~FVE metadat FVEK a použít ho pro vytvoření dm-crypt zařízení.

\obr{Schéma použitých DM targetů při odemykání BitLocker zařízení}{fig:bitlocker-dm-scheme}{0.75}{img/bitlocker-dm-schema.png}

Jak bylo popsáno v~části \ref{sec:data-map} a naznačeno na obrázku \ref{fig:bitlocker-decrypt}, struktura uložení dat na BitLocker zařízení je relativně složitá a dešifrované zařízení má některá data, jako například NTFS hlavičku, přesunutá na jiná místa. I~toto lze pomocí Device Mapperu vyřešit jednoduše --- mapování různých sektorů původního (šifrovaného) zařízení na zařízení nové je jednou ze základních funkcí, kterou Device Mapper nabízí, a tato funkcionalita je dostupná pro všechny targety, tedy i pro crypto target.

Stačí tedy vědět, které sektory šifrovaného zařízení je třeba namapovat na které sektory otevřeného zařízení. Metadatové části, které jsou v~otevřeném zařízení v~BitLockeru nahrazeny nulami, mohou být stejně snadno nahrazeny pomocí Device Mapper targetu zero, který je mimo jiné také ochrání proti náhodnému přepsání, protože zápisy na dm-zero zařízení jsou zahazovány\cite{KernelZero}.

Příklad, jak může fungovat mapování mezi šifrovaným BitLocker zařízením a otev\-ře\-ným zařízením v~linuxovém prostředí, je vidět na obrázku \ref{fig:bitlocker-dm-scheme}.

Kompletní Device Mapper tabulka pro testovací 100 MiB zařízení je uvedena v~tabulce \ref{tab:bitlocker-dm-table}.

\tab{DM tabulka odemčeného BitLocker zařízení v~Linuxu}{tab:bitlocker-dm-table}{0.65}{|l|l|l|l|l|l|l|l|l|}{
  \hline
   \textbf{start} & \textbf{velikost} & \textbf{target} & \textbf{šifra} & \textbf{klíč} & \textbf{IV offset} & \textbf{offset}  \\ \hline
 0 & 16 & crypt & aes-xts-plain64 & a4..52 & 68904 & 68904 \\ \hline
 16 & 68760 & crypt & aes-xts-plain64 & a4..52 & 16 & 16 \\ \hline
 68776 & 128 & zero & \multicolumn{4}{c|}{} \\ \hline
 68904 & 16 & zero & \multicolumn{4}{c|}{} \\ \hline
 68920 & 21424 & crypt & aes-xts-plain64 & a4..52 & 68920 & 68920 \\ \hline
 90344 & 128 & zero & \multicolumn{4}{c|}{} \\ \hline
 90472 & 22632 & crypt & aes-xts-plain64 & a4..52 & 90472 & 90472 \\ \hline
 113104 & 128 & zero & \multicolumn{4}{c|}{} \\ \hline
 113232 & 91568 & crypt & aes-xts-plain64 & a4..52 & 113232 & 113232 \\ \hline
}

Můžeme zde vidět strukturu otevřeného zařízení, kdy prvních 16 sektorů zabírá crypt target, který mapuje data původně uložená na offsetu 68904 sektorů --- to je NTFS hlavička, která je v~původním BitLocker zařízení uložena za prvními metadaty --- tomu odpovídá i nastavení IV offsetu, protože inicializační vektor v~BitLockeru je číslo sektoru, na kterém jsou data skutečně uložena, nikoli číslo sektoru, na kterém se data nachází na otevřeném zařízení. Následuje první část dat, opět mapovaná pomocí crypt targetu. Za ní jsou dvě dm-zero zařízení, která nahrazují první kopii FVE metadat a již zmíněnou NTFS hlavičku přesunutou na začátek zařízení. Zbývají již jen dvě kopie FVE metadat, opět nahrazené pomocí dm-zero, a tři datové oblasti mapované pomocí dm-crypt.

\n{1}{Implementace nástroje pro práci BitLocker metadaty}\label{sec:implementace-nastroj}

Z~výše popsaného Device Mapper targetu dm-crypt a jeho možností vyplývá, že pro správnou podporu BitLockeru v~linuxovém prostředí stačí dodat klíč, šifru a správné umístění šifrovaných dat a výsledkem bude blokové zařízení, které lze používat pro čtení i pro zápis stejně, jako jakékoli jiné nešifrované blokové zařízení.

Protože žádné z~existujících řešení neumožňuje tyto informace získat, bylo rozhodnuto vytvořit nový jednoduchý nástroj, který z~BitLocker hlavičky a FVE metadat všechny potřebné informace získá a pomocí nástroje \texttt{dmsetup} vytvoří potřebné Device Mapper zařízení.

\n{2}{API a implementace}

Jako programovací jazyk pro implementaci byl zvolen Python, který umožňuje rychlý vývoj a díky široké škále vestavěných i externích knihoven má dostatek funkcí pro práci s~blokovými zařízení i šifrováním. Menší nevýhodou této volby je nemožnost použít výsledný kód jako knihovnu pro programy napsané v~jazyce C (respektive v~jiném jazyce než Python), ale jako vhodné API v~tomto případě může posloužit i volání externí utility, pokud má k~dispozici vhodné módy a přepínače, které umožní přijímat heslo poslané na standardní vstup a omezí interakci s~uživatelem. Systémové nástroje, které budeme dále používat, navíc s~takovým použitím konzolových nástrojů používají a knihovna libblockdev (viz \ref{sec:libblockdev}) umí s~takovými nástroji bez problémů pracovat.

Vzhledem k~tomu, že celá práce s~metadaty je uceleným ohraničeným krokem, kdy po nastavení Device Mapperu již není potřeba další interakce s~blokovým zařízením (jelikož se o~vše stará kernel), dává i částečně smysl celou tuto záležitost pojmout jako samostatný proces, který z~disku načte potřebné informace, vytvoří Device Mapper zařízení a ukončí se.

Součástí nástroje jsou následné moduly, které lze využívat i samostatně, případně z~jiných Python projektů:

\begin{itemize}
	\item \textbf{constants} obsahující různé konstanty vztahující se k~BitLocker metadatům (velikosti hlaviček, offsety...),
	\item \textbf{dm} obsahující pomocné funkce pro práci s~Device Mapper zařízeními,
	\item \textbf{entry} obsahující třídu \texttt{MetadataEntry} a pokrývající funkcionalitu potřebnou pro práci s~metadatovými FVE záznamy (\ref{sec:fve-metadata-entry}),
	\item \textbf{fve} obsahující třídu \texttt{FVE}, která využívá ostatní zmíněné moduly pro kompletní parsování FVE metadat,
	\item \textbf{header} obsahující třídu \texttt{BitLockerHeader} sloužící pro práci s~BitLocker hlavičkou a extrakci potřebných dat z~ní,
	\item \textbf{keys} obsahující třídy \texttt{AESEncryptedKey}, \texttt{FVEK}, \texttt{UnencryptedKey}, \texttt{VMK} a sloužící pro práci s~různými klíči nacházejícími se ve FVE metadatech včetně jejich dešifrování a
	\item \textbf{utils} obsahující různé pomocné funkce a nástroje pro práci blokovými zařízeními a pro dekódování přečtených dat.
\end{itemize}

Rozčlenění do jednotlivých tříd s~definovaným rozhraním umožňuje snadné budoucí rozšíření pro starší verze BitLocker metadat, které jsou často jen mírně odlišné (více informací o~rozdílech ve starších verzích BitLockeru v~části \ref{sec:old-versions}) a bude tedy možné při jejich implementaci znovu použít většinu kódu.

Na obrázku \ref{fig:uml-classes} je k~dispozici diagram tříd komponent implementovaného nástroje bitlockersetup. V~přiložených zdrojových kódech je také k~dispozici kompletní automaticky generovaná API dokumentace.

\obr{Diagram tříd vytvořeného nástroje bitlockersetup}{fig:uml-classes}{0.90}{img/class-diagram.png}

\n{2}{Uživatelské rozhraní}

Implementovaný nástroj, pojmenovaný \texttt{bitlockersetup}, má několik podpříkazů, které umožňují volit mezi základními operacemi. Jsou to především:

\begin{itemize}
	\item \textbf{open} sloužící pro odemčení BitLocker zařízení,
	\item \textbf{close} sloužící pro jeho opětovné uzamčení a tedy odstraněný vytvořeného Device Mapper zařízení,
	\item \textbf{dump} který vypíše veškeré informace o~vybraném zařízení a
	\item \textbf{uuid} který vypíše UUID vybraného BitLocker zařízení.
\end{itemize}

Kompletní manuálová stránka pro bitlockersetup je dostupná v~příloze \ref{attachment:manpage}. Ukázka odemčení BitLocker zařízení pomocí bitlockersetup je na obrázku \ref{fig:bitlockersetup-open}.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
$ sudo bitlockersetup open /dev/sdb2 bitlocker
Password for '/dev/sdb2': 
Created device mapper device '/dev/mapper/bitlocker'.

\end{lstlisting}
		\caption{Ukázka použití nástroje \texttt{bitlockersetup} pro odemčení BitLocker zařízení}
		\label{fig:bitlockersetup-open}
\end{figure}

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true]
$ sudo bitlockersetup dump /dev/sdb2
Encryption method:	AES-XTS 128-bit encryption
Volume identifier:	1f8bf933-8323-4c97-8a89-a67625ac8f40
Creation time:		2019-02-03 09:10:22.265406
Description:		DESKTOP-NPM7RCA G: 2/3/2019
VMK
	Identifier:	f0f61678-fb6f-4ab1-934a-7094f5b68a85
	Type:		VMK protected with password
	Salt:		03 d1 b4 23 6b f4 5b df e4 bd dd f4 83 ec 47 ee
	AES-CCM encrypted key
		Nonce data:	2019-02-03 09:10:36.052000
		Nonce counter:	3
		Key:	 0d a8 61 01 72 46 9b 7b 34 40 ... 1d 21 0a b7 b8 c4
VMK
	Identifier:	012e56c1-4ed6-4527-8abf-7a9f29e0b521
	Type:		VMK protected with recovery password
	Salt:		46 ee b7 10 0e 43 4d d4 a5 ab eb c6 21 f4 f1 84
	AES-CCM encrypted key
		Nonce data:	2019-02-03 09:10:36.052000
		Nonce counter:	6
		Key:	 91 a0 ad e9 0c 08 e8 1e 3d 2f 7d ... 36 46 40 6b e7
FVEK
	AES-CCM encrypted key
		Nonce data:	2019-02-03 09:10:36.052000
		Nonce counter:	8
		Key:	 13 08 8b fd e9 12 5a a6 7d 7b 53 ... 94 df c8 49 66

\end{lstlisting}
		\caption{Ukázka použití nástroje \texttt{bitlockersetup} pro zobrazení informací o~BitLocker zařízení}
		\label{fig:bitlockersetup-dump}
\end{figure}

\n{2}{Instalace}

Pro snadnou instalaci nástroje bitlockersetup je k~dispozici standardní \texttt{Makefile} skript, instalaci lze tedy provést ze složky \texttt{bitlockersetup} pomocí příkazu \texttt{make install}. K~dispozici je také SPEC soubor pro tvorbu RPM balíčků pro distribuci Fedora, balíčky pro Fedoru 30 jsou součástí přiložených zdrojových kódů.

Podporována je také instalace pomocí standardních metod pro Python balíčky pomocí skriptu \texttt{setup.py}, případně pomocí nástroje \texttt{pip}.

\n{1}{Integrace se systémovými nástroji}\label{sec:integrace}

Samotný nástroj pro práci s~BitLockerem, vytvořený v~rámci této práce, není dos\-ta\-teč\-ným řešením pro kompletní podporu BitLocker zařízení v~Linuxu. Cílem je, aby uživatel nepoznal, že nepracuje s~nativním zařízením --- tedy, aby po připojení přenosného disku zašifrovaného pomocí technologie BitLocker, byl tento automaticky rozpoznán a uživateli bylo v~grafickém rozhraní nabídnuto jeho odemčení, bez nutnosti další interakce ze strany uživatele (kromě zadání hesla). Tímto se zabývá druhá polovina praktické části této práce, kdy bude vytvořený nástroj integrován do existujících nástrojů a knihoven pro práci s~úložnými zařízeními.

\n{2}{UDisks}\label{sec:udisks}

I~když je často kritizována roztříštěnost linuxových systémů, která se projevuje také velkým množstvím různých grafických pracovních prostředí, pro práci s~úložnými ná\-stro\-ji toto naštěstí neplatí a nejoblíbenější pracovní prostředí jako GNOME, KDE a Xfce používají jednotné API poskytované nástrojem UDisks, byť obvykle nepřímo, jako například v~případě prostředí GNOME, které nad UDisks používá ještě další vrstvu v~podobě nástroje GVfs\cite{GVfs2019}.

Díky výše popsanému stačí, aby UDisks správně označil vybrané BitLocker zařízení jako šifrované a umožnil jeho odemčení, a bez dalších úprav pak nástroje, které UDisks používají, nabídnou uživateli jeho odemčení.

UDisks není jediným nástrojem, ale spíše projektem, který poskytuje hned několik různých možností pro práci s~úložnými zařízeními --- démona \emph{udisksd}, knihovnu \emph{libudisks} a konzolový nástroj \emph{udisksctl}\cite{UDisks2018}. Pro uživatele API, které UDisks nabízí, je nejdůležitější, že poskytuje DBus API\footnote{DBus je softwarová sběrnice, která umožňuje komunikaci mezi jednotlivými aplikacemi a démony (IPC) a také spouštění funkcí z~API, které poskytují systémový démoni (RPC). V~grafických prostředích jako GNOME a KDE se používají právě pro komunikaci se systémovými démony jako je UDisks a další.\cite{Palmieri2005}}, kdy na interface \emph{org.freedesktop.UDisks2} vystavuje všechna existující bloková zařízení a umožňuje snadný přístup k~jejich vlastnostem a přes nabízené funkce také jejich úpravy a správu.

\n{3}{Identifikace BitLockeru}\label{sec:bitlocker-identification}

První věcí, kterou je v~případě implementace podpory BitLockeru v~UDisks vyřešit, je schopnost identifikace BitLocker zařízení. Jak již bylo řečeno, pro rychlou identifïkaci BitLocker zařízení slouží jeho hlavička a především signatura \texttt{-FVE-FS-} (o~BitLocker hlavičce více v~části \ref{sec:header}). UDisks ale sám jednotlivá zařízení neskenuje a jejich hlavičky a signatury nečte, na to používá existující systémovou databázi blokových zařízení vytvořenou démonem UDev.

UDev slouží primárně pro zprostředkování událostí o~přidání, odstranění a změnách blokových zařízení z~kernelu do user space. Vytváří také speciální soubory a symbolické odkazy pro přímý přístup k~blokovým zařízení v~adresáři \texttt{/dev}. Důležitou součástí UDevu jsou pravidla, která určují, co má UDev s~daným zařízením v~jakém případě dělat --- umožňují například jejich inicializaci, nahrání potřebných ovladačů nebo prosté spuštění programů a démonů, které dané zařízení mají ovládat.\cite{Kenlon2018} Kromě toho také s~využitím různých systémových nástrojů zjistí o~nově připojeném zařízení všechny potřebné informace, tedy také přečte jeho signaturu z~hlavičky. K~tomu využívá nástroje \texttt{blkid} z~projektu \texttt{util-linux}\cite{Zak2017}.

Do knihovny libblkid (a tedy i do nástroje blkid) byla podpora pro detekci BitLocker signatury přidána ve verzi 2.33 vydané v~listopadu 2018\cite{Zak2018}. Díky tomu UDev správně identifikuje BitLocker zařízení a v~jeho databázi jsou tato zařízení vedena jako \emph{crypto} zařízení typu \emph{BitLocker}, jak je vidět na obrázku \ref{fig:udev-bitlocker}.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{center}
\centering
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true, xleftmargin=.35\textwidth, xrightmargin=.35\textwidth]
E: DEVNAME=/dev/sda2
E: DEVTYPE=partition
E: SUBSYSTEM=block
E: ID_BUS=usb
E: ID_FS_TYPE=BitLocker
E: ID_FS_USAGE=crypto
\end{lstlisting}
\end{center}
		\caption{Vybrané informace z~UDev databáze o~připojeném BitLocker zařízení}
		\label{fig:udev-bitlocker}
\end{figure}

UDev (a díky němu i UDisks) tak má vše potřebné pro identifikaci nově připojeného zařízení jako BitLocker zařízení. UDisks tuto identifikaci z~UDevu převezme a správně nastaví hodnoty property \texttt{IdType} a \texttt{IdUsage}, jak je vidět na obrázku \ref{fig:udisks-bitlocker-without-support}.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{center}
\centering
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true, xleftmargin=.2\textwidth, xrightmargin=.2\textwidth]
/org/freedesktop/UDisks2/block_devices/sda2:
  org.freedesktop.UDisks2.Block:
    Configuration:              []
    CryptoBackingDevice:        '/'
    Device:                     /dev/sda2
    DeviceNumber:               2050
    HintAuto:                   true
    HintIconName:
    HintIgnore:                 false
    HintName:
    HintPartitionable:          true
    HintSymbolicIconName:
    HintSystem:                 false
    Id:
    IdLabel:
    $\textcolor{blue}{IdType:}$                     $\textcolor{blue}{BitLocker}$
    IdUUID:
    $\textcolor{blue}{IdUsage:}$                    $\textcolor{blue}{crypto}$
\end{lstlisting}
\end{center}
		\caption{Informace o BitLocker zařízení z pohledu UDisks}
		\label{fig:udisks-bitlocker-without-support}
\end{figure}

V~UDisks však stále chybí některé informace o~BitLocker zařízení jako například UUID, které UDev nezná, protože jeho získání z~BitLocker hlavičky knihovna libblkid nepodporuje.

UDisks také pro toto zařízení nevytvoří interface \emph{org.freedesktop.UDisks2.Encrypted}, které normálně poskytuje další funkce pro práci se šifrovanými zařízeními. To je logické, protože i když je zařízení identifikováno jako šifrované, UDisks s~ním neumí nijak pracovat. O~přidání této funkcionality a zmíněného interface pro BitLocker zařízení pojednává část \ref{sec:udisks-implementation}.

\n{3}{Knihovna libblockdev}\label{sec:libblockdev}

UDisks nepracuje s~blokovými zařízeními na přímo, ale využívá buď UDev databázi (pro zjištění informací o~existujících zařízeních, viz část o~identifikaci BitLocker zařízení \ref{sec:bitlocker-identification}), nebo knihovnu libblockdev (pro samotnou manipulaci se zařízeními)\cite{Podzimek2017}. Jakákoli nová vlastnost, která má být přidána do UDisks, musí tedy být napřed přidána do libblockdev.

Libblockdev je relativně jednoduchá knihovna napsaná v~jazyce C, která poskytuje jednotné API pro různé technologie pro práci s~úložnými zařízeními jako je LVM, Btrfs nebo LUKS. Je také modulární a poskytované funkce jsou rozděleny do pluginů, které je možné používat samostatně. Kromě jazyka C nabízí také rozhraní pro Python díky využití technologie GObject introspection.\cite{Podzimek2015}

Pro implementace nových funkcí pro práci s~BitLockerem byl zvolen \emph{crypto} plugin této knihovny, který již obsahuje funkce pro práci s~šifrovacími technologiemi LUKS/dm-crypt a TrueCrypt/VeraCrypt. Součástí implementace jsou celkem čtyři nové funkce pro práci s~BitLocker zařízeními. Jejich pojmenování a navrhované API vychází z~obdobných funkcí pro technologii LUKS/dm-crypt. Deklarace nových funkcí jsou k~dispozici na obrázku \ref{fig:libblockdev-bitlocker}.

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{lstlisting}[frame=none, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true, xleftmargin=.1\textwidth, xrightmargin=.1\textwidth]
gboolean bd_crypto_bitlocker_open (const gchar *device,
                                   const gchar *name,
                                   const gchar *passphrase,
                                   GError **error);
gboolean bd_crypto_bitlocker_close (const gchar *bitlocker_device,
                                    GError **error);
gboolean bd_crypto_device_is_bitlocker (const gchar *device,
                                        GError **error);
gchar* bd_crypto_bitlocker_uuid (const gchar *device,
                                 GError **error);

\end{lstlisting}
		\caption{Interface nově implemetovaných funkcí pro práci s~BitLockerem v~knihovně libblockdev}
		\label{fig:libblockdev-bitlocker}
\end{figure}

Nově implementované funkce slouží k~odemčení (\texttt{open}) a opětovnému uzamčení (\texttt{close}) BitLocker zařízení, zjištění zda se skutečně jedná o~BitLocker zařízení \\(\texttt{is$\_$bitlocker}) a zjištění UUID\footnote{V terminologii BitLockeru spíše GUID, ale zde se držíme linuxové terminologie, kde se tento univerzální identifikátor nazývá obvykle právě UUID.} BitLocker zařízení (\texttt{uuid}). API nových funkcí se drží standardu daném ostatními funkcemi v~libblockdev, kdy funkce vrací boolean hodnotu určující, zda bylo její volání úspěšné, či nikoli (s~výjimkou funkcí, které vrací nějakou konkrétní hodnotu, jako zde UUID, v~takové případě vrací buď dané UUID jako textový řetězec, nebo \texttt{NULL} v~případě neúspěchu) a v~případě chyby nastavují chybu do uživatelem předané výstupní proměnné \texttt{error}.

Díky tomu, že mnohé technologie pro práci s~úložnými zařízeními neposkytují API v~podobě knihoven, má libblockdev propracovaný systém pomocných funkcí pro volání konzolových nástrojů a při samotné implementaci s~použitím vytvořeného nástroje pro práci s~BitLockerem tak bylo možné tyto funkce využít.

Patche pro knihovnu libblockdev implementující výše zmíněné funkce jsou součástí k~této práci přiložených zdrojových kódů.

\n{3}{Implementace v~UDisks}\label{sec:udisks-implementation}

V~samotném UDisks je nejprve třeba vyřešit identifikaci BitLocker zařízení jako podporovaného šifrovaného zařízení, jak je popsáno v~části \ref{sec:bitlocker-identification}. K~tomu slouží nově přidaná funkce \texttt{udisks$\_$linux$\_$block$\_$is$\_$bitlocker}, která využívá informace z~UDev databáze pro identifikaci blokového zařízení jako BitLocker. S~pomocí této funkce pak stačí UDisks již jen upravit tak, aby BitLocker zařízení přidal DBus interface \emph{org.freedesktop.org.UDisks2.Encrypted} a zpřístupnil tak obecné property a funkce pro šifrovaná zařízení. Které bude třeba následně upravit tak, aby správně podporovaly i BitLocker.

Díky tomu, že UDisks podporuje kromě technologie LUKS/dm-crypt také zařízení šifrovaná pomocí TrueCrypt/VeraCrypt, je kód je již připraven na podporu více různých technologií, kdy jsou k~dispozici obecné implementace funkcí sloužící k~obsluze API volání pro odemykání a uzamykání šifrovaných zařízení a pro přidání podpory pro nové technologie stačí vytvořit pomocné funkce s~minimálními úpravami v~implementaci veřejných funkcí.

Pro BitLocker takto byly vytvořeny pomocné funkce \texttt{bitlocker$\_$open$\_$job$\_$func} a \texttt{bitlocker$\_$close$\_$job$\_$func}, které jsou volány z~obecných funkcí \texttt{handle$\_$unlock} a \texttt{handle$\_$lock}, které obsluhují API volání veřejných funkcí \emph{Unlock} a \emph{Lock}. Jejich API je definováno velmi obecně (povinným parametrem funkce \emph{Unlock} je pouze heslo, ostatní jsou předávány jako nepovinný seznam klíč-hodnota\cite{Storaged2019}), takže pro BitLocker není potřeba jej nijak měnit. Ostatní funkce veřejného API (\emph{ChangePassphrase} a \emph{Resize}), které nejsou pro BitLocker podporovány byly upraveny tak, aby při zavolání vracely chybovou hlášku informující o~tom, že tato funkcionalita není pro BitLocker podporována, protože u~existujícího DBus interface nelze funkce dynamicky odebírat.

Díky tomu, že všechny součásti UDisks --- tedy DBus démon, knihovna i konzolový nástroj --- jsou generovány ze stejného kódu, není potřeba upravovat žádné další části kódu, kromě výše zmíněných, a podpora pro odemykání BitLocker zařízení bude automaticky propagována i do nástroje \texttt{udisksctl}.

Na obrázku \ref{fig:udisks-bitlocker-with-support} je viditelné BitLocker zařízení z~pohledu UDisks po aplikaci výše zmíněných změn. Nově je přidáno \emph{org.freedesktop.org.UDisks2.Encrypted} interface po\-sky\-tu\-jí\-cí další informace o~zařízení (funkce zde nejsou viditelné, jedná se pouze o~informační výpis z~nástroje \texttt{udisksctl}).

\begin{figure}[h]
		\centering
		\captionsetup{width=0.65\linewidth}
\begin{center}
\centering
\begin{lstlisting}[frame=none, escapechar=$, basicstyle=\ttfamily\small, columns=fullflexible, keepspaces=true, xleftmargin=.2\textwidth, xrightmargin=.2\textwidth]
/org/freedesktop/UDisks2/block_devices/sda2:
  org.freedesktop.UDisks2.Block:
    Configuration:              []
...
    HintPartitionable:          true
    HintSymbolicIconName:
    HintSystem:                 false
    Id:
    IdLabel:
    $\textcolor{blue}{IdType:}$                     $\textcolor{blue}{BitLocker}$
    $\textcolor{blue}{IdUUID:}$                     $\textcolor{blue}{1f8bf933-8323-4c97-...}$
    $\textcolor{blue}{IdUsage:}$                    $\textcolor{blue}{crypto}$
  $\textcolor{red}{org.freedesktop.UDisks2.Encrypted:}$
    ChildConfiguration:         []
    CleartextDevice:            '/'
    $\textcolor{red}{HintEncryptionType:}$          $\textcolor{red}{BitLocker}$
    MetadataSize:               0

\end{lstlisting}
\end{center}
		\caption{Informace o~BitLocker zařízení z~pohledu UDisks s~přidanou podporou pro BitLocker}
		\label{fig:udisks-bitlocker-with-support}
\end{figure}

Patche pro nástroj UDisks implementující výše zmíněné funkce jsou součástí k~této práci přiložených zdrojových kódů.

\n{2}{Podpora v~grafických prostředích}

Jak již bylo zmíněno výše (\ref{sec:udisks}), jednotlivá grafická rozhraní spoléhají při identifikaci šifrovaných zařízení na UDisks --- pokud má dané zařízení typ \emph{crypto} a má k~dispozici interface \emph{org.freedesktop.org.UDisks2.Encrypted}, označí jej jako šifrované a nabídnou jeho odemčení. Po instalaci UDisks s~aplikovanými změnami zmíněnými výše jsou tak BitLocker zařízení viditelná v~grafickém prostředí jako šifrovaná a při pokusu o~jejich připojení bude uživatel dotázán na heslo po jehož zadání mu bude zpřístupněno nově vytvořené otevřené zařízení.

Na obrázku \ref{fig:bitlocker-xfce} je ukázka toho chování z~prostředí Xfce.

\obr{Připojení BitLocker zařízení v~prostředí Xfce}{fig:bitlocker-xfce}{0.75}{img/bitlocker-xfce.png}

% ============================================================================ %
\nn{Závěr}

Cílem této práce bylo popsat technologii pro šifrování disku BitLocker, její současnou podporu v~linuxových systémech a tuto podporu případně rozšířit. Teoretická část nabízí stručný popis BitLockeru, kdy jsou s~pomocí existujících zdrojů a vlastního testování popsány použité kryptografické funkce --- AES-CBC a AES-XTS použité pro šifrování dat uložených na disku a AES-CCM pro ochranu v~metadatech uložených klíčů. Popsán je také diskový formát BitLockeru --- hlavička a metadatové oblasti BitLocker zařízení a jejich obsah, včetně dvou druhů v~metadatech uložených klíčů --- FVEK použitého pro šifrování uložených dat, který je sám uložen v~metadatech chráněný pomocí druhé klíče VMK.

Samostatná kapitola je vyhrazena existujícím nástrojům pro práci s~BitLockerem v~linuxovém prostředí. Bohužel ani knihovna libbde, ani nástroj dislocker nejsou zcela vyhovujícím řešením, především z~pohledu zvolených technologií, na kterých staví a problematickým a komplikovaným možnostem dalšího případného rozšíření.

Pro podporu BitLockeru v~linuxovém prostředí byla v~rámci praktické části zvolena kombinace použití existujících technologií pro práci se šifrovanými zařízeními a nově vytvořeného nástroje pro práci s~BitLocker metadaty. O~samotné (de)šifrování dat při jejich čtení a zápisu se stará jaderný ovladač Device Mapper, který je použit i pro nativní linuxové řešení šifrování disku LUKS/dm-crypt. Ten již nyní podporuje všechny nezbytné kryptografické funkce pro nejnovější verzi BitLockeru. Nově vytvořený nástroj bitlockersetup slouží pouze k~získání FVEK klíče z~BitLocker metadat a také k~výpočtu umístění jednotlivých datových oblastí na šifrovaném zařízení. Pomocí těchto informací a pomocí Device Mapperu pak vytváří nové zařízení pro přístup k~šifrovaným datům. Pro dosažení uživatelské přívětivosti tohoto řešení byl upraven systémový démon \mbox{UDisks} tak, aby dokázal odemknout a prezentovat BitLocker zařízení stejně jako nativní LUKS/dm-crypt zařízení. Díky tomu je zaručena podpora BitLocker zařízení ve všech hlavních grafických prostředí, která UDisks používají pro práci s~blokovými zařízeními. Díky tomu systém automaticky rozpozná například připojený USB flash disk šifrovaný pomocí BitLockeru a uživateli pro jeho použití stačí jen zadat heslo stejně, jako by se jednalo o~disk šifrovaný pomocí LUKS/dm-crypt.

\subsection*{Možnosti budoucího rozšíření}\addcontentsline{toc}{subsection}{Možnosti budoucího rozšíření}

Pro případné budoucí rozšíření této práce se nabízí rozšíření podpory dalších verzí BitLockeru. Současná implementace podporuje pouze nejnovější variantu využívající k~šifrování dat algoritmus AES-XTS. Rozšíření o~podporu pro algoritmy AES-CBC a AES-CBC s~Elephant difuzérem by umožnilo podporovat i zařízení vytvořená na starších verzích operačního systému Microsoft Windows. Další vhodné rozšíření by představovalo úpravu přepsání vytvořeného nástroje tak, aby mohl být začleněn do projektu cryptsetup, který slouží pro práci se zařízeními šifrovanými pomocí technologií LUKS/dm-crypt a TrueCrypt/VeraCrypt v~linuxových systémech. Tím by se výrazně zjednodušilo a urychlilo rozšíření podpory BitLockeru do různých linuxových distribucí.


% ============================================================================ %
